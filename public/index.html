<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockMate Pro - Sistema de Inventario</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de gestión de inventario y ventas">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StockMate">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/icons/icon-32.svg">
    <link rel="apple-touch-icon" href="/icons/icon-192.svg">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <img id="logoComercio" src="" alt="" style="display: none; height: 55px; max-width: 80px; object-fit: contain; border-radius: 8px;">
                        <div>
                            <h1 id="appName">MI COMERCIO</h1>
                            <p>by StockMate Pro</p>
                        </div>
                    </div>
                </div>
                <div class="header-buttons">
                    <div class="header-user-info">
                        <i data-lucide="user" class="lucide-icon"></i>
                        <span class="user-name" id="usuarioActual"></span>
                    </div>
                    <button class="admin-btn" id="btnSuperAdmin" onclick="abrirSuperAdmin()"
                            style="display: none; background: #f1c40f; color: #2c3e50;">
                        <i data-lucide="crown" class="lucide-icon"></i> Clientes
                    </button>
                    <button class="admin-btn btn-admin-primary" onclick="abrirAdmin()">
                        <i data-lucide="settings" class="lucide-icon"></i> Admin
                    </button>
                    <button class="admin-btn btn-salir" onclick="cerrarSesion()">
                        <i data-lucide="log-out" class="lucide-icon"></i> Salir
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Modal Admin -->
    <div id="adminModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2><i data-lucide="settings" class="lucide-icon"></i> Panel de Administración</h2>
                <button class="admin-modal-close" onclick="cerrarAdmin()"><i data-lucide="x" class="lucide-icon-sm"></i></button>
            </div>
            <div class="admin-modal-body">
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchAdminTab('config', event)"><i data-lucide="sliders-horizontal" class="lucide-icon-sm"></i> Configuración</button>
                    <button class="admin-tab" onclick="switchAdminTab('scanner', event)"><i data-lucide="scan-barcode" class="lucide-icon-sm"></i> Scanner</button>
                    <button class="admin-tab" onclick="switchAdminTab('datos', event)"><i data-lucide="database" class="lucide-icon-sm"></i> Datos</button>
                    <button class="admin-tab" onclick="switchAdminTab('backups', event)"><i data-lucide="hard-drive" class="lucide-icon-sm"></i> Backups</button>
                </div>

                <!-- Tab Configuración -->
<div id="adminConfig" class="admin-tab-content active">
    
    <!-- Sección Logo -->
    <div class="config-section" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0; color: #333;"><i data-lucide="image" class="lucide-icon-sm"></i> Logo del Comercio</h4>

        <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
            <!-- Preview del logo -->
            <div id="logoPreviewContainer" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden;">
                <img id="logoPreview" src="" alt="" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
                <span id="logoPlaceholder" style="color: #aaa;"><i data-lucide="camera" class="lucide-icon-lg"></i></span>
            </div>

            <!-- Controles -->
            <div style="flex: 1; min-width: 200px;">
                <input type="file" id="inputLogo" accept="image/png,image/jpeg,image/gif,image/webp,image/svg+xml" style="display: none;" onchange="previewLogo(this)">

                <button onclick="document.getElementById('inputLogo').click()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-right: 10px;">
                    <i data-lucide="folder-open" class="lucide-icon-sm"></i> Seleccionar Imagen
                </button>

                <button onclick="eliminarLogo()" id="btnEliminarLogo" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
                    <i data-lucide="trash-2" class="lucide-icon-sm"></i> Quitar Logo
                </button>

                <p style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    Formatos: PNG, JPG, GIF, WEBP, SVG. Tamaño recomendado: 200x200px
                </p>
            </div>
        </div>

        <button onclick="guardarLogo()" id="btnGuardarLogo" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 15px; display: none;">
            <i data-lucide="save" class="lucide-icon-sm"></i> Guardar Logo
        </button>
    </div>

    <!-- Sección Nombre (la que ya existía) -->
    <div class="app-name-section">
        <label>Nombre de la aplicación</label>
        <input type="text" id="inputAppName" placeholder="Ej: Mi Tienda">
        <button onclick="guardarNombreApp()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
            <i data-lucide="save" class="lucide-icon-sm"></i> Guardar nombre
        </button>
    </div>

    <!-- Sección Cambiar Contraseña -->
    <div class="config-section" style="background: #fff3e0; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #ffcc80;">
        <h4 style="margin: 0 0 15px 0; color: #e65100;"><i data-lucide="key-round" class="lucide-icon-sm"></i> Cambiar Contraseña</h4>

        <div style="display: grid; gap: 12px; max-width: 350px;">
            <div>
                <label style="display: block; font-size: 0.85em; margin-bottom: 5px; color: #555;">Contraseña actual</label>
                <div class="password-wrapper">
                    <input type="password" id="passwordActual" placeholder="Tu contraseña actual" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    <button type="button" class="password-toggle" onclick="togglePassword('passwordActual', this)"><i data-lucide="eye" class="lucide-icon-sm"></i></button>
                </div>
            </div>
            <div>
                <label style="display: block; font-size: 0.85em; margin-bottom: 5px; color: #555;">Nueva contraseña</label>
                <div class="password-wrapper">
                    <input type="password" id="passwordNuevo" placeholder="Mínimo 6 caracteres" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    <button type="button" class="password-toggle" onclick="togglePassword('passwordNuevo', this)"><i data-lucide="eye" class="lucide-icon-sm"></i></button>
                </div>
            </div>
            <div>
                <label style="display: block; font-size: 0.85em; margin-bottom: 5px; color: #555;">Confirmar nueva contraseña</label>
                <div class="password-wrapper">
                    <input type="password" id="passwordConfirmar" placeholder="Repetir nueva contraseña" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    <button type="button" class="password-toggle" onclick="togglePassword('passwordConfirmar', this)"><i data-lucide="eye" class="lucide-icon-sm"></i></button>
                </div>
            </div>
            <button onclick="cambiarPassword()" style="background: #e65100; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-top: 5px;">
                <i data-lucide="lock" class="lucide-icon-sm"></i> Cambiar Contraseña
            </button>
            <div id="resultadoCambioPassword"></div>
        </div>
    </div>
</div>

                <!-- Tab Scanner de Códigos de Barras -->
                <div id="adminScanner" class="admin-tab-content">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <span style="font-size: 3em;"><i data-lucide="scan-barcode" style="width: 48px; height: 48px;"></i></span>
                        <h3 style="margin: 10px 0 5px 0; color: #2e7d32;">Scanner de Códigos de Barras</h3>
                        <p style="color: #666; font-size: 0.9em;">Conectá una pistola lectora USB y empezá a escanear</p>
                    </div>

                    <div style="display: grid; gap: 20px; max-width: 500px; margin: 0 auto;">
                        <!-- Toggle Scanner -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; display: flex; align-items: center; gap: 15px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="scannerEnabled" checked onchange="BarcodeScanner.toggle()">
                                <span class="toggle-slider"></span>
                            </label>
                            <div>
                                <span style="font-weight: 600; font-size: 1.05em;">Scanner activado</span>
                                <p style="font-size: 0.8em; color: #666; margin: 3px 0 0 0;">
                                    Detecta automáticamente cuando escaneás un código
                                </p>
                            </div>
                        </div>

                        <!-- Toggle Modo Continuo -->
                        <div style="background: #fff8e1; padding: 20px; border-radius: 10px; display: flex; align-items: center; gap: 15px; border: 1px solid #ffe082;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="scannerModoContinuo" onchange="BarcodeScanner.toggleModoContinuo()">
                                <span class="toggle-slider"></span>
                            </label>
                            <div>
                                <span style="font-weight: 600; font-size: 1.05em;">Modo continuo en Ventas</span>
                                <p style="font-size: 0.8em; color: #666; margin: 3px 0 0 0;">
                                    Cada escaneo agrega el artículo y prepara un nuevo formulario
                                </p>
                            </div>
                        </div>

                        <!-- Info de uso -->
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; border: 1px solid #a5d6a7;">
                            <strong style="font-size: 1em; color: #2e7d32;"><i data-lucide="list" class="lucide-icon-sm"></i> Cómo funciona:</strong>
                            <ul style="margin: 12px 0 0 0; padding-left: 20px; font-size: 0.9em; color: #333; line-height: 1.8;">
                                <li><strong>Buscar:</strong> Escanea → busca el producto en el catálogo</li>
                                <li><strong>Ventas:</strong> Escanea → completa el formulario de venta</li>
                                <li><strong>Stock:</strong> Escanea → muestra info y permite editar</li>
                            </ul>
                        </div>

                        <!-- Producto no encontrado -->
                        <div style="background: #fce4ec; padding: 20px; border-radius: 10px; border: 1px solid #f8bbd9;">
                            <strong style="font-size: 1em; color: #c2185b;"><i data-lucide="sparkles" class="lucide-icon-sm"></i> Producto nuevo:</strong>
                            <p style="margin: 8px 0 0 0; font-size: 0.9em; color: #333;">
                                Si escaneás un código que no existe, el sistema te ofrece crear el producto con el código de barras ya cargado.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Tab Gestión de Datos -->
                <div id="adminDatos" class="admin-tab-content">
                    <div style="margin-bottom: 20px;">
                        <strong>Gestión de Datos</strong>
                        <p style="color: #666; font-size: 0.9em; margin-top: 4px;">Eliminá datos específicos sin afectar el resto. Siempre se crea un backup antes de borrar.</p>
                    </div>
                    
                    <div id="datosStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <!-- Se llena con JS -->
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 15px; color: #333;"><i data-lucide="calendar-x" class="lucide-icon-sm"></i> Limpiar Ventas por Período</h4>
                        <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                            <div>
                                <label style="display: block; font-size: 0.85em; margin-bottom: 5px;">Mes</label>
                                <select id="limpiarMes" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12" selected>Diciembre</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85em; margin-bottom: 5px;">Año</label>
                                <input type="number" id="limpiarAnio" value="2025" min="2020" max="2030" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 80px;">
                            </div>
                            <button onclick="limpiarVentasMes()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i data-lucide="trash-2" class="lucide-icon-sm"></i> Eliminar ventas del mes
                            </button>
                        </div>
                        <div id="resultadoLimpiarMes" style="margin-top: 10px;"></div>
                    </div>

                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #90caf9; margin-bottom: 20px;">
    <h4 style="margin-bottom: 10px; color: #0d47a1;"><i data-lucide="database" class="lucide-icon-sm"></i> Migración de Datos</h4>
    <p style="font-size: 0.9em; color: #555; margin-bottom: 15px;">
        Descargá tu base de datos actual para llevarla a otro entorno o guardarla en tu PC.
    </p>

    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <button onclick="descargarBaseDatos()" style="background: #1976d2; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
            <i data-lucide="download" class="lucide-icon-sm"></i> Descargar mi DB
        </button>

        <div style="height: 30px; width: 1px; background: #ccc;"></div>

        <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="document.getElementById('inputDbUpload').click()" style="background: #f39c12; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                <i data-lucide="upload" class="lucide-icon-sm"></i> Subir/Restaurar DB
            </button>
            <input type="file" id="inputDbUpload" accept=".db" style="display: none;" onchange="subirBaseDatos()">
            <span style="font-size: 0.8em; color: #e67e22; max-width: 200px;"><i data-lucide="alert-triangle" class="lucide-icon-sm"></i> Reemplazará todos los datos.</span>
        </div>
    </div>
</div>

                    <div class="danger-zone">
                        <h4><i data-lucide="alert-triangle" class="lucide-icon-sm"></i> Zona de peligro</h4>
                        <div class="danger-zone-buttons">
                            <button class="danger-btn danger-btn-warning" onclick="resetearStockCero()">
                                <i data-lucide="trending-down" class="lucide-icon-sm"></i> Poner Stock en 0
                            </button>
                            <button class="danger-btn danger-btn-critical" onclick="eliminarCatalogoCompleto()">
                                <i data-lucide="trash-2" class="lucide-icon-sm"></i> Eliminar Productos
                            </button>
                            <button class="danger-btn" onclick="limpiarTabla('ventas')">
                                <i data-lucide="x" class="lucide-icon-sm"></i> Borrar Ventas
                            </button>
                            <button class="danger-btn" onclick="limpiarTabla('cambios')">
                                <i data-lucide="x" class="lucide-icon-sm"></i> Borrar Cambios
                            </button>
                            <button class="danger-btn" onclick="limpiarTabla('cuentas')">
                                <i data-lucide="x" class="lucide-icon-sm"></i> Borrar Cuentas Ctes.
                            </button>
                        </div>
                        <p class="danger-zone-note">
                            Estas acciones son irreversibles. Se crea un backup automático antes de cada operación.
                        </p>
                    </div>
                </div>

                <!-- Tab Backups -->
                <div id="adminBackups" class="admin-tab-content">
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Historial de cambios</strong>
                            <p style="color: #666; font-size: 0.9em; margin-top: 4px;">Cada acción genera un backup automático. Podés restaurar a cualquier punto anterior.</p>
                        </div>
                        <button onclick="cargarBackups()" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">
                            <i data-lucide="refresh-cw" class="lucide-icon-sm"></i> Actualizar
                        </button>
                    </div>
                    <div id="backupLog" class="backup-log">
                        <div class="backup-empty">Cargando backups...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="container">
        <!-- NAVEGACIÓN TABS -->
        <div class="tabs">
            <button class="tab-btn" onclick="switchTab('busqueda', event)"><i data-lucide="search" class="lucide-icon"></i> Buscar Precios</button>
            <button class="tab-btn active" onclick="switchTab('cajas', event)"><i data-lucide="calculator" class="lucide-icon"></i> Cajas Diarias</button>
            <button class="tab-btn" onclick="switchTab('stock', event)"><i data-lucide="package" class="lucide-icon"></i> Stock</button>
            <button class="tab-btn" onclick="switchTab('cuentas', event)"><i data-lucide="wallet" class="lucide-icon"></i> Cuentas Corrientes</button>
            <button class="tab-btn" onclick="switchTab('promedios', event)"><i data-lucide="trending-up" class="lucide-icon"></i> Promedios</button>
            <button class="tab-btn" onclick="switchTab('historico', event)"><i data-lucide="history" class="lucide-icon"></i> Histórico de Ventas</button>
        </div>

        <!-- ==================== TAB 1: BÚSQUEDA ====================-->
        <div id="busqueda" class="tab-content">
            <div class="card">
                <h2>Buscar Producto por Código</h2>
                <div class="form-group input-search">
                    <input type="text" id="busquedaInput" placeholder="Buscar por código o descripción..." autofocus>
                    <span class="search-icon"><i data-lucide="search" class="lucide-icon-sm"></i></span>
                </div>
                <div id="busquedaResultado"></div>
            </div>
        </div>

        <!-- TAB 2 CAJAS DIARIAS -->
<div id="cajas" class="tab-content active">

<!-- Selector de mes y días -->
    <div style="margin-top: 40px; margin-bottom: 20px;">
        <h3 id="mesActualTitulo" style="color: #333; margin-bottom: 15px;"></h3>
        <div id="diasDelMes" class="dias-grid"></div>
    </div>

  <!-- BOX MODO OSCURO: Registro de Venta -->
    <div class="venta-box-dark">
        <h3 class="venta-box-title"><i data-lucide="shopping-bag" class="lucide-icon"></i> Registrar Nueva Venta</h3>

        <!-- Contenedor de formularios de artículos -->
        <div id="contenedorArticulos">
            <!-- Artículo 1 (siempre visible) -->
            <div class="articulo-form" data-index="0">
                <!-- Búsqueda rápida -->
                <div class="search-box">
                    <input type="text" class="search-input-dark busqueda-rapida" placeholder="Buscar por código o descripción...">
                    <div class="resultado-rapido"></div>
                </div>

                <!-- Formulario de venta en línea -->
                <div class="venta-form-inline" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                    <div class="form-field" style="width: 130px;">
                        <label>Fecha</label>
                        <input type="date" class="campo-fecha" required>
                    </div>

                    <div class="form-field" style="width: 140px;">
                        <label>Artículo</label>
                        <input type="text" class="campo-articulo" placeholder="Código" required>
                    </div>

                    <div class="form-field" style="width: 70px;">
                        <label>Cant.</label>
                        <input type="number" class="campo-cantidad" value="1" required style="text-align: center;">
                    </div>

                    <div class="form-field" style="width: 110px;">
                        <label>Precio</label>
                        <input type="number" class="campo-precio" step="0.01" placeholder="0.00" required>
                    </div>

                    <div class="form-field" style="width: 80px;">
                        <label>Desc.</label>
                        <select class="campo-descuento">
                            <option value="0">0%</option>
                            <option value="5">5%</option>
                            <option value="10">10%</option>
                            <option value="15">15%</option>
                            <option value="20">20%</option>
                            <option value="25">25%</option>
                            <option value="30">30%</option>
                            <option value="35">35%</option>
                            <option value="40">40%</option>
                            <option value="50">50%</option>
                        </select>
                    </div>

                    <div class="form-field total-field" style="width: 150px;">
                        <label>Total</label>
                        <span class="total-exacto"></span>
                        <input type="text" class="total-input campo-total" value="$0">
                    </div>

                    <div class="form-field" style="width: 100px;">
                        <label>Cat.</label>
                        <input type="text" class="campo-categoria" readonly>
                    </div>

                    <div class="form-field" style="width: 90px;">
                        <label>Factura</label>
                        <div class="factura-select">
                            <button type="button" class="factura-btn active" data-value="A">A</button>
                            <button type="button" class="factura-btn" data-value="B">B</button>
                        </div>
                    </div>

                    <div class="form-field" style="flex: 1; min-width: 140px;">
                        <label>Pago</label>
                        <select class="campo-tipoPago">
                            <option value="Otro" selected>Otro...</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Tarjeta Crédito">T. Crédito</option>
                            <option value="Tarjeta Débito">T. Débito</option>
                            <option value="MP">MercadoPago</option>
                            <option value="MODO">MODO</option>
                            <option value="CDNI">CDNI</option>
                            <option value="QR">QR</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Cta Cte">Cta Corriente</option>
                        </select>
                    </div>

                    <div style="width: 100%; display: flex; align-items: center; gap: 15px; margin-top: 5px;">
                        <div class="form-field" style="flex: 1;">
                            <input type="text" class="campo-comentarios" placeholder="Comentarios opcionales..." style="width: 100%;">
                        </div>

                        <div class="form-field">
                            <div class="checkbox-container">
                                <input type="checkbox" class="campo-esCambio" style="width: 18px; height: 18px; margin: 0; cursor: pointer;">
                                <label style="color: #e74c3c; cursor: pointer; font-weight: bold; margin: 0; font-size: 0.9em; text-transform: uppercase;">Devolución</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón agregar otro artículo -->
        <div style="margin-top: 10px; display: flex; justify-content: flex-start;">
            <button class="btn-agregar-otro" onclick="agregarOtroArticulo()">+ Agregar otro artículo</button>
        </div>

        <!-- Botón registrar venta -->
        <button id="btnRegistrarVenta" class="btn-registrar-dark" onclick="registrarVenta(event)" style="margin-top: 15px;">
            <i data-lucide="check" class="lucide-icon-sm"></i> Registrar Venta (1 artículo) - $0
        </button>
    </div>

    <!-- Lista de ventas del día seleccionado -->
    <div class="ventas-list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 id="ventasDiaTitulo" style="margin: 0;">Ventas del día</h3>
            <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 8px;">
                <label style="color: #000000; font-size: 0.9em; margin: 0;">Caja inicial:</label>
                <input type="text" id="cajaInicial" placeholder="$0" 
                    style="width: 120px; padding: 6px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white; text-align: right; font-weight: bold;"
                    onblur="guardarCajaInicial()" 
                    onkeyup="formatearInputMoneda(this); if(event.key === 'Enter') { this.blur(); }">
            </div>
        </div>
        <div id="listaVentas"></div>
    </div>
</div>

<!-------------- TAB 3 STOCK ---------------->
<div id="stock" class="tab-content">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">Actualizar Stock y Precios</h2>
            <button onclick="abrirModalProducto('')" style="background: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <i data-lucide="sparkles" class="lucide-icon-sm"></i> Agregar Artículo Nuevo
            </button>
        </div>

        <!-- BOX OSCURO: búsqueda + edición -->
        <div class="stock-box-dark">

            <!-- Búsqueda por código -->
            <div class="form-group">
                <label>Buscar por código de artículo</label>
                <div class="input-search">
                    <input type="text" id="stockBusquedaCodigo" placeholder="Buscar por código o descripción...">
                    <span class="search-icon"><i data-lucide="search" class="lucide-icon-sm"></i></span>
                </div>
                <div id="stockBusquedaResultado" class="error-text" style="display:none;"></div>
            </div>

            <!-- Panel de edición de producto -->
            <div id="stockEditor" class="stock-editor" style="display:none;">
                <h3 id="stockProductoTitulo"></h3>

                <div class="stock-editor-grid">
                    <div class="stock-field">
                        <label>Código</label>
                        <div id="stockCodigo" class="stock-value"></div>
                    </div>
                    <div class="stock-field">
                        <label>Categoría</label>
                        <div id="stockCategoria" class="stock-value"></div>
                    </div>
                    <div class="stock-field">
                        <label>Precio Público</label>
                        <input type="number" id="stockPrecioPublico" step="0.01">
                    </div>
                    <div class="stock-field">
                        <label>Costo</label>
                        <input type="number" id="stockCosto" step="0.01">
                    </div>
                    <div class="stock-field">
                        <label>Stock actual</label>
                        <div id="stockActual" class="stock-value"></div>
                    </div>
                    <div class="stock-field">
                        <label>Cantidad a agregar / sacar</label>
                        <input type="number" id="stockDelta" step="1" value="0">
                    </div>
                    <div class="stock-field">
                        <label>Stock final</label>
                        <div id="stockFinal" class="stock-value"></div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="guardarStockYPrecios()"><i data-lucide="save" class="lucide-icon-sm"></i> Guardar cambios</button>
                <div id="stockEditorMensaje" class="error-text" style="margin-top:10px; display:none;"></div>
            </div>
        </div> <!-- /stock-box-dark -->

        <!-- WIDGETS DE STOCK BAJO -->
        <div class="stock-alertas-container">
            <div class="stock-alerta-widget stock-alerta-critico">
                <div class="stock-alerta-header">
                    <span class="stock-alerta-icon"><i data-lucide="alert-circle" class="lucide-icon"></i></span>
                    <h4>Última unidad</h4>
                    <span class="stock-alerta-badge" id="badgeStock1">0</span>
                </div>
                <div class="stock-alerta-list" id="listaStock1">
                    <div class="stock-alerta-empty">Cargando...</div>
                </div>
            </div>
            <div class="stock-alerta-widget stock-alerta-bajo">
                <div class="stock-alerta-header">
                    <span class="stock-alerta-icon"><i data-lucide="alert-triangle" class="lucide-icon"></i></span>
                    <h4>Quedan 2 unidades</h4>
                    <span class="stock-alerta-badge" id="badgeStock2">0</span>
                </div>
                <div class="stock-alerta-list" id="listaStock2">
                    <div class="stock-alerta-empty">Cargando...</div>
                </div>
            </div>
        </div>

        <hr style="margin: 30px 0;">

        <!-- BOX 1: Resumen de stock por categoría -->
        <div class="stock-box-light">
            <div class="stock-resumen-top">
                <h3>Detalle de stock total</h3>
                <div id="stockResumenTotal" class="stock-resumen-total"></div>
            </div>
            <div id="stockResumen" class="stock-resumen"></div>
        </div>

        <!-- BOX 2: Listado completo de artículos -->
        <div class="stock-box-light" style="margin-top: 20px;">
            <div class="stock-list-header">
                <h3>Listado completo de artículos</h3>
                <button type="button" class="btn-filtros-stock" onclick="toggleFiltrosStock()">
                    <i data-lucide="filter" class="lucide-icon-sm"></i>
                    <span>Filtros</span>
                </button>
            </div>

            <!-- Panel de filtros (oculto por defecto) -->
            <div id="panelFiltrosStock" class="panel-filtros-stock" style="display: none;">
                <div class="filtros-stock-grid">
                    <div class="filtro-grupo">
                        <label>Categoría</label>
                        <select id="filtroCategoria">
                            <option value="">Todas las categorías</option>
                        </select>
                    </div>
                    <div class="filtro-grupo">
                        <label>Stock</label>
                        <select id="filtroStock">
                            <option value="">Todo el stock</option>
                            <option value="0">Sin stock (0)</option>
                            <option value="1">1 unidad</option>
                            <option value="2">2 unidades</option>
                            <option value="1-5">1 a 5 unidades</option>
                            <option value="6+">6 o más</option>
                        </select>
                    </div>
                    <div class="filtro-grupo filtro-texto">
                        <label>Buscar</label>
                        <input type="text" id="filtroTexto" placeholder="Código o descripción...">
                    </div>
                </div>
            </div>

            <div class="stock-tabla-wrapper">
                <table class="stock-tabla" id="stockTabla">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Descripción</th>
                            <th>Categoría</th>
                            <th class="num">Precio Público</th>
                            <th class="num">Costo</th>
                            <th class="num">Stock</th>
                            <th style="width: 50px; text-align: center;"><i data-lucide="trash-2" class="lucide-icon-sm"></i></th>
                        </tr>
                    </thead>
                    <tbody id="stockTablaBody">
                        <!-- filas dinámicas -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- BOX PEQUEÑO: importar/actualizar productos por CSV -->
        <div class="stock-box-csv">
            <h3><i data-lucide="package" class="lucide-icon"></i> Importar Productos CSV</h3>
            <p class="stock-csv-text">
                <strong>Primera vez:</strong> Cargá tu archivo con todos los productos.<br>
                Formato: <code>codigo,descripcion,categoria,precioPublico,costo,stock</code>
            </p>

            <div class="upload-area" onclick="document.getElementById('csvProductos').click()">
                <div class="icon"><i data-lucide="folder-open" class="lucide-icon-lg"></i></div>
                <p><strong>Click para importar productos</strong></p>
                <p style="font-size: 0.9em; color: #999; margin-top: 10px;">
                    Crea productos nuevos o actualiza existentes
                </p>
                <input type="file" id="csvProductos" accept=".csv" onchange="importarProductosCSV()" style="display:none;">
            </div>
            <div id="alertaProductos" class="alert"></div>

            <hr style="margin: 20px 0; border: none; border-top: 1px dashed #ddd;">

            <h3><i data-lucide="refresh-cw" class="lucide-icon"></i> Actualizar Solo Stock</h3>
            <p class="stock-csv-text">
                Usa esta opción para actualizar cantidades. Formato: <code>codigo,cantidad</code>
            </p>

            <div style="margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                <label style="font-weight: bold; margin-bottom: 5px; display: block;">¿Qué debe hacer el sistema?</label>
                <div style="display: flex; gap: 15px;">
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="modoStock" value="replace" checked>
                        <i data-lucide="file-edit" class="lucide-icon-sm"></i> Corregir (Reemplazar stock)
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="modoStock" value="add">
                        <i data-lucide="plus" class="lucide-icon-sm"></i> Sumar (Agregar al actual)
                    </label>
                </div>
            </div>

            <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                <div class="icon"><i data-lucide="bar-chart-3" class="lucide-icon-lg"></i></div>
                <p><strong>Click para subir CSV</strong></p>
                <input type="file" id="csvFile" accept=".csv" onchange="uploadCSV()" style="display:none;">
            </div>

            <div id="alertaStock" class="alert"></div>
            <div id="resultadoStock"></div>
        </div> <!-- /stock-box-csv -->
    </div> <!-- /card -->
</div> <!-- /tab-content stock -->


<!-- ==================== TAB 4: CUENTAS CORRIENTES ====================-->
<div id="cuentas" class="tab-content">
    <div class="card">
        <h2>Cuentas Corrientes</h2>
        
        <!-- Formulario para nueva cuenta -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px; font-size: 1.2em;"><i data-lucide="plus-circle" class="lucide-icon"></i> Nueva Cuenta</h3>
            <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                <div class="form-field" style="flex: 1; min-width: 200px;">
                    <label>Nombre del Cliente *</label>
                    <input type="text" id="cuentasCliente" placeholder="Ej: Juan Pérez">
                </div>
                <div class="form-field" style="width: 150px;">
                    <label>Teléfono</label>
                    <input type="text" id="cuentasTelefono" placeholder="Opcional">
                </div>
                <button class="btn-registrar" onclick="crearCuenta()" style="height: 40px;">Crear Cuenta</button>
            </div>
        </div>

        <div id="alertaCuentas" class="alert"></div>

        <!-- Mini tabs internos -->
        <div class="mini-tabs">
            <button class="mini-tab active" onclick="switchCuentasTab('activas', event)">Cuentas Activas</button>
            <button class="mini-tab" onclick="switchCuentasTab('saldadas', event)">Cuentas Saldadas</button>
        </div>

        <!-- Grid de cuentas activas -->
        <div id="cuentasActivas" class="cuentas-tab-content active">
            <div id="cuentasGridActivas"></div>
        </div>

        <!-- Grid de cuentas saldadas -->
        <div id="cuentasSaldadas" class="cuentas-tab-content">
            <div id="cuentasGridSaldadas"></div>
        </div>

        <!-- Totales generales -->
        <div id="totalesCuentas"></div>
    </div>
</div>

<!-- ==================== TAB 4b: PROMEDIOS ====================-->
 <div id="promedios" class="tab-content">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Evolución Mensual y Promedios</h2>
            <div style="display: flex; gap: 10px;">
                <select id="promedioAnio" onchange="cargarPromedios()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-weight: bold;"></select>
                <select id="promedioMes" onchange="cargarPromedios()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-weight: bold;">
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
                <button onclick="cargarPromedios()" class="btn" style="background: #208090; color: white;"><i data-lucide="refresh-cw" class="lucide-icon-sm"></i></button>
            </div>
        </div>

        <div class="promedios-header-grid">
            <div class="card-promedio">
                <h4>Venta Total Mes</h4>
                <div class="valor" id="promTotalMes">$0</div>
            </div>
            <div class="card-promedio">
                <h4>Días Transcurridos</h4>
                <div class="valor" id="promDiasTranscurridos">0</div>
            </div>
            <div class="card-promedio" style="border-bottom: 3px solid #007bff;">
                <h4>Promedio Diario Actual</h4>
                <div class="valor" id="promPromedioActual" style="color: #007bff;">$0</div>
            </div>
            <div class="card-promedio" style="border-bottom: 3px solid #e67e22;">
                <h4>Prendas Vendidas</h4>
                <div class="valor" id="promTotalPrendas" style="color: #d35400;">0</div>
                <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                    Prom. diario: <strong id="promPromedioPrendas">0</strong>
                </div>
            </div>
             <div class="card-promedio">
                <h4>Proyección Fin de Mes</h4>
                <div class="valor" id="promProyeccion" style="color: #aaa;">-</div>
            </div>
        </div>

        <div style="overflow-x: auto; border-radius: 8px;">
            <table class="tabla-promedios">
                <thead>
                    <tr>
                        <th style="width: 150px;">Día</th>
                        <th>Venta Diaria</th>
                        <th class="col-acumulado">Acumulado Mes</th>
                        <th class="col-promedio">Promedio Diario</th>
                    </tr>
                </thead>
                <tbody id="tablaPromediosBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<!-------------- TAB 5 HISTÓRICO ---------------->
<div id="historico" class="tab-content">
    <div class="card">
        <h2>Histórico y Análisis de Ventas</h2>

        <div class="historico-filtros">
            <div class="periodo-box">
                <label>Seleccionar año</label>
                <select id="historicoAnio"></select>
            </div>
            <div class="periodo-box">
                <label>Seleccionar meses</label>
                <div class="meses-grid" id="historicoMeses">
                    </div>
            </div>
        </div>

        <button class="btn-toggle-graficos" onclick="toggleSeccionGraficos()">
    <span id="iconoGraficos"><i data-lucide="chevron-down" class="lucide-icon-sm"></i></span>
    <span>Mostrar gráficos</span>
</button>

        <div id="seccionGraficos" class="graficos-container" style="display: none; margin-bottom: 30px;">
            <div class="graficos-selector">
                <button class="grafico-tab active" data-chart="categorias" onclick="cambiarGrafico('categorias')">
                    <i data-lucide="tag" class="lucide-icon-sm"></i> Por categoría
                </button>
                <button class="grafico-tab" data-chart="comparativa-periodo" onclick="cambiarGrafico('comparativa-periodo')">
        <i data-lucide="scale" class="lucide-icon-sm"></i> Vs. Año Anterior
    </button>
                <button class="grafico-tab" data-chart="pagos" onclick="cambiarGrafico('pagos')">
                    <i data-lucide="credit-card" class="lucide-icon-sm"></i> Métodos de pago
                </button>
                <button class="grafico-tab" data-chart="productos" onclick="cambiarGrafico('productos')">
                    <i data-lucide="trophy" class="lucide-icon-sm"></i> Top productos
                </button>
            </div>
            <div class="grafico-wrapper">
    <div id="chartCategorias" class="chart-canvas active"></div>
    
    <div id="chartComparativaPeriodo" class="chart-canvas">
        <div style="text-align: center; color: #666; padding: 20px;">
            Cargando comparativa...
        </div>
    </div>
    
    <div id="chartPagos" class="chart-canvas"></div>
    <div id="chartProductos" class="chart-canvas"></div>
</div>
        </div>

        <div class="historico-metricas">
            <div class="metric-card">
                <h4>Ventas totales</h4>
                <div class="metric-valor" id="histTotalVentas">$ 0</div>
                <div class="metric-detalle" id="histTotalTickets">0 tickets</div>
            </div>
            <div class="metric-card">
                <h4>Ticket promedio</h4>
                <div class="metric-valor" id="histTicketPromedio">$ 0</div>
                <div class="metric-detalle">por venta</div>
            </div>
            <div class="metric-card">
                <h4>Prendas vendidas</h4>
                <div class="metric-valor" id="histPrendasVendidas">0</div>
                <div class="metric-detalle">unidades</div>
            </div>
            <div class="metric-card" style="border-left: 3px solid #3498db;">
                <h4>Factura A</h4>
                <div class="metric-valor" id="histFacturaAMonto" style="color: #3498db;">$ 0</div>
                <div class="metric-detalle" id="histFacturaACant">0 tickets</div>
            </div>
            <div class="metric-card" style="border-left: 3px solid #e67e22;">
                <h4>Factura B</h4>
                <div class="metric-valor" id="histFacturaBMonto" style="color: #e67e22;">$ 0</div>
                <div class="metric-detalle" id="histFacturaBCant">0 tickets</div>
            </div>
        </div>

        <div class="historico-seccion">
            <div class="historico-seccion-header">
                <h3>Detalle de operaciones <span class="hist-periodo-label" id="histPeriodoLabel">-</span></h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-export" onclick="exportarHistorico('csv')" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <i data-lucide="download" class="lucide-icon-sm"></i> CSV
                    </button>
                    <button class="btn-export" onclick="exportarHistorico('excel')" style="background: #217346; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <i data-lucide="file-spreadsheet" class="lucide-icon-sm"></i> Excel
                    </button>
                    <button id="btnFiltrosTabla" class="btn-toggle-filtros" onclick="toggleFiltrosTabla()">
                        <i data-lucide="filter" class="lucide-icon-sm"></i> Filtros
                    </button>
                </div>
            </div>

            <div id="filtrosTablaPanel" class="filtros-panel" style="display: none;">
                <div class="filtros-grid">
                    <div class="filtro-item">
                        <label>Buscar artículo</label>
                        <input type="text" id="histFiltroArticulo" placeholder="..." onkeyup="aplicarFiltrosTabla()">
                    </div>
                    <div class="filtro-item">
                        <label>Categoría</label>
                        <select id="histFiltroCategoria" onchange="aplicarFiltrosTabla()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label>Tipo de pago</label>
                        <select id="histFiltroTipoPago" onchange="aplicarFiltrosTabla()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label>Monto mínimo</label>
                        <input type="number" id="histFiltroMontoMin" placeholder="$0" onkeyup="aplicarFiltrosTabla()">
                    </div>
                    <div class="filtro-item">
                        <label>Monto máximo</label>
                        <input type="number" id="histFiltroMontoMax" placeholder="Sin límite" onkeyup="aplicarFiltrosTabla()">
                    </div>
                    <div class="filtro-item">
                        <label>Cantidad mínima</label>
                        <input type="number" id="histFiltroCantidadMin" placeholder="0" onkeyup="aplicarFiltrosTabla()">
                    </div>
                </div>
                <div class="filtros-acciones">
                    <button class="btn-limpiar-filtros" onclick="limpiarFiltrosTabla()">
                        Limpiar filtros
                    </button>
                    <span id="filtrosResultado" class="filtros-resultado"></span>
                </div>
            </div>

            <div class="hist-ventas-wrapper">
                <table class="hist-ventas-tabla">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Artículo</th>
                            <th>Cat.</th>
                            <th class="num">Cant.</th>
                            <th class="num">Precio</th>
                            <th class="num">Desc.</th>
                            <th class="num">Total</th>
                            <th>Pago</th>
                            <th>Fact.</th>
                        </tr>
                    </thead>
                    <tbody id="histVentasBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="ventas-import-mini">
            <div class="ventas-import-info">
                <h4><i data-lucide="upload" class="lucide-icon-sm"></i> Importar histórico</h4>
                <p>Cargá ventas antiguas desde un archivo CSV (Formato: Fecha, Articulo, Cantidad...)</p>
            </div>
            <div>
                <button class="btn-importar-mini" onclick="document.getElementById('csvVentas').click()">
                    <i data-lucide="folder-open" class="lucide-icon-sm"></i> Seleccionar Archivo
                </button>
                <input type="file" id="csvVentas" accept=".csv" onchange="uploadVentasCSV()" style="display:none;">
            </div>
        </div>
        <div id="alertaVentasCSV" class="alert"></div>

        <div class="comparativa-seccion-integrada">
            <h3 class="titulo-seccion"><i data-lucide="calendar-range" class="lucide-icon"></i> Comparativa Anual de Rendimiento</h3>
            
            <div class="comparativa-controles">
                <div class="select-group">
                    <label>Año Base (Anterior)</label>
                    <select id="compAnio1" class="form-control-lg"></select>
                </div>
                <div class="vs-badge">VS</div>
                <div class="select-group">
                    <label>Año Objetivo (Actual)</label>
                    <select id="compAnio2" class="form-control-lg"></select>
                </div>
                <button onclick="cargarDataComparativa()" class="btn-comparar">
                    <i data-lucide="bar-chart-2" class="lucide-icon-sm"></i> Comparar Rendimiento
                </button>
            </div>

            <div id="resumenComparativa" class="comp-dashboard" style="display: none;">
                <div class="comp-card">
                    <h4>Facturación Total</h4>
                    <div class="comp-grid">
                        <div class="dato-anio anterior">
                            <span id="lblAnio1_fact">-</span>
                            <div id="valAnio1_fact" class="valor">$0</div>
                        </div>
                        <div class="dato-anio actual">
                            <span id="lblAnio2_fact">-</span>
                            <div id="valAnio2_fact" class="valor">$0</div>
                        </div>
                    </div>
                    <div class="comp-footer">
                        Variación: <span id="var_fact" class="badge-var neutral">0%</span>
                    </div>
                </div>

                <div class="comp-card">
                    <h4>Prendas Vendidas</h4>
                    <div class="comp-grid">
                        <div class="dato-anio anterior">
                            <span id="lblAnio1_unid">-</span>
                            <div id="valAnio1_unid" class="valor">0</div>
                        </div>
                        <div class="dato-anio actual">
                            <span id="lblAnio2_unid">-</span>
                            <div id="valAnio2_unid" class="valor">0</div>
                        </div>
                    </div>
                    <div class="comp-footer">
                        Variación: <span id="var_unid" class="badge-var neutral">0%</span>
                    </div>
                </div>

                <div class="comp-card">
                    <h4>Ticket Promedio</h4>
                    <div class="comp-grid">
                        <div class="dato-anio anterior">
                            <span id="lblAnio1_ticket">-</span>
                            <div id="valAnio1_ticket" class="valor">$0</div>
                        </div>
                        <div class="dato-anio actual">
                            <span id="lblAnio2_ticket">-</span>
                            <div id="valAnio2_ticket" class="valor">$0</div>
                        </div>
                    </div>
                    <div class="comp-footer">
                        Variación: <span id="var_ticket" class="badge-var neutral">0%</span>
                    </div>
                </div>
            </div>

            <div id="tablaComparativaContainer" style="display: none; margin-top: 30px;">
                <h4 style="margin-bottom: 15px; color: #666;">Desglose Mensual</h4>
                <div class="table-responsive">
                    <table class="comp-table">
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th class="text-right border-left">Facturación <span id="thAnio1"></span></th>
                                <th class="text-right">Facturación <span id="thAnio2"></span></th>
                                <th class="text-center">Variación $</th>
                                <th class="text-right border-left">Unidades <span id="thAnio1_u"></span></th>
                                <th class="text-right">Unidades <span id="thAnio2_u"></span></th>
                                <th class="text-center">Variación Unid.</th>
                            </tr>
                        </thead>
                        <tbody id="bodyComparativa"></tbody>
                    </table>
                </div>
            </div>
        </div>
        </div> </div>

<script src="app.js"></script>


<div id="toast" class="toast"></div>

<div id="modalCtaCte" class="admin-modal" style="z-index: 2000;">
    <div class="admin-modal-content" style="max-width: 400px;">
        <div class="admin-modal-header" style="background: #e67e22;">
            <h2><i data-lucide="user" class="lucide-icon"></i> Datos del Cliente</h2>
            <button class="admin-modal-close" onclick="cerrarModalCtaCte()"><i data-lucide="x" class="lucide-icon-sm"></i></button>
        </div>
        <div class="admin-modal-body">
            <div class="form-group">
                <label>Nombre y Apellido *</label>
                <input type="text" id="ccNombre" placeholder="Ej: Lionel Messi" autofocus>
            </div>
            <div class="form-group">
                <label>Teléfono</label>
                <input type="text" id="ccTelefono" placeholder="Ej: 11 1234-5678">
            </div>
            <div class="form-group">
                <label>Artículo de Interés / Devuelto</label>
                <input type="text" id="ccArticulo" placeholder="Ej: Jeans 505 (Cambio)">
            </div>
            <div class="form-group">
                <label>Comentarios de la Cuenta</label>
                <textarea id="ccComentarios" rows="2" style="width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 8px;" placeholder="Detalles extra..."></textarea>
            </div>
            <button class="btn-full" onclick="confirmarVentaCtaCte()" style="background: #e67e22; color: white; margin-top: 10px; font-weight: bold; padding: 12px;">
                Confirmar y Registrar
            </button>
        </div>
    </div>
</div>

<div id="modalNuevoProducto" class="admin-modal" style="z-index: 2000;">
    <div class="admin-modal-content">
        <div class="admin-modal-header" style="background: #27ae60;">
            <h2><i data-lucide="sparkles" class="lucide-icon"></i> Nuevo Artículo</h2>
            <button class="admin-modal-close" onclick="cerrarModalProducto()"><i data-lucide="x" class="lucide-icon-sm"></i></button>
        </div>
        <div class="admin-modal-body">
            <div class="form-group">
                <label>Código de Barras</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="npCodigoBarras" placeholder="Escaneá o escribí el código de barras" style="flex: 1;">
                    <button type="button" onclick="document.getElementById('npCodigoBarras').focus(); BarcodeScanner.showIndicator(true, 'Escaneá el código...');" style="padding: 8px 12px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;" title="Escanear"><i data-lucide="scan-barcode" class="lucide-icon-sm"></i></button>
                </div>
            </div>
            <div class="form-group">
                <label>Código Artículo *</label>
                <input type="text" id="npCodigo" placeholder="Ej: REMERA-001" style="font-weight: bold;">
            </div>
            <div class="form-group">
                <label>Descripción *</label>
                <input type="text" id="npDescripcion" placeholder="Ej: Remera Algodón Negra">
            </div>
            <div class="form-group">
                <label>Categoría</label>
                <input type="text" id="npCategoria" placeholder="Ej: REMERAS">
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;">
                    <label>Precio Público</label>
                    <input type="number" id="npPrecio" step="0.01" value="0">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Costo</label>
                    <input type="number" id="npCosto" step="0.01" value="0">
                </div>
            </div>
            <div class="form-group">
                <label>Stock Inicial</label>
                <input type="number" id="npStock" value="0">
            </div>

            <button class="btn-guardar-modal" onclick="guardarNuevoProducto()">
                <i data-lucide="save" class="lucide-icon-sm"></i> Guardar Producto
            </button>
        </div>
    </div>
</div>

<div id="modalSuperAdmin" class="admin-modal">
    <div class="admin-modal-content" style="max-width: 950px;">
        <div class="admin-modal-header" style="background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);">
            <h2 style="color: #2c3e50;"><i data-lucide="crown" class="lucide-icon"></i> Gestión de Clientes</h2>
            <button class="close-admin-modal" onclick="cerrarSuperAdmin()" style="color:#2c3e50;"><i data-lucide="x" class="lucide-icon-sm"></i></button>
        </div>

        <div class="admin-modal-body">
            <div style="background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;">
                <h4 style="margin-top:0; color:#555;"><i data-lucide="sparkles" class="lucide-icon-sm"></i> Dar de Alta Nuevo Comercio</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                    <div class="form-group" style="margin:0;">
                        <label>Usuario (Login)</label>
                        <input type="text" id="saUser" placeholder="ej: local1">
                    </div>
                    <div class="form-group" style="margin:0;">
                        <label>Contraseña</label>
                        <input type="text" id="saPass" placeholder="******">
                    </div>
                    <div class="form-group" style="margin:0;">
                        <label>Nombre Fantasía</label>
                        <input type="text" id="saNombre" placeholder="ej: Tienda Norte">
                    </div>
                    <button onclick="crearUsuarioSaas()" class="btn-guardar-modal" style="margin:0; background:#27ae60;">+ Crear</button>
                </div>
            </div>

            <h4 style="color:#555;"><i data-lucide="folder" class="lucide-icon-sm"></i> Comercios Registrados</h4>
            <div style="overflow-x: auto; max-height: 400px; border: 1px solid #eee; border-radius: 8px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                    <thead style="background: #f8f9fa; position: sticky; top: 0;">
                        <tr>
                            <th style="padding:10px 8px; text-align:left; border-bottom:2px solid #ddd;">Usuario</th>
                            <th style="padding:10px 8px; text-align:left; border-bottom:2px solid #ddd;">Comercio</th>
                            <th style="padding:10px 8px; text-align:left; border-bottom:2px solid #ddd;">Último Login</th>
                            <th style="padding:10px 8px; text-align:center; border-bottom:2px solid #ddd;">Errores</th>
                            <th style="padding:10px 8px; text-align:center; border-bottom:2px solid #ddd;">Estado</th>
                            <th style="padding:10px 8px; text-align:center; border-bottom:2px solid #ddd;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="listaUsuariosBody" style="background: white;">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para resetear contraseña de usuario -->
<div id="modalResetPasswordSaas" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center;">
    <div style="background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90%;">
        <h3 style="margin: 0 0 20px 0;"><i data-lucide="key-round" class="lucide-icon"></i> Resetear Contraseña</h3>
        <p style="margin-bottom: 15px; color: #666;">Usuario: <strong id="resetPasswordUsuarioSaas"></strong></p>
        <div style="margin-bottom: 15px;">
            <label style="display: block; font-size: 0.85em; margin-bottom: 5px;">Nueva contraseña</label>
            <div class="password-wrapper">
                <input type="password" id="adminNuevoPasswordSaas" placeholder="Mínimo 6 caracteres" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <button type="button" class="password-toggle" onclick="togglePassword('adminNuevoPasswordSaas', this)"><i data-lucide="eye" class="lucide-icon-sm"></i></button>
            </div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="cerrarModalResetPasswordSaas()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Cancelar</button>
            <button onclick="confirmarResetPasswordSaas()" style="background: #e65100; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">Resetear</button>
        </div>
    </div>
</div>

<!-- Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
                console.log('SW registrado:', registration.scope);

                // Detectar actualizaciones
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Nueva versión disponible
                            if (confirm('Nueva versión disponible. ¿Actualizar ahora?')) {
                                newWorker.postMessage('skipWaiting');
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch((error) => console.error('Error registrando SW:', error));
    });
}
</script>
</body>
</html>