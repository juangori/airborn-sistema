<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airborn - Sistema de Inventario</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <h1 id="appName">üõçÔ∏è MI COMERCIO</h1>
                    <p>Sistema de Gesti√≥n de Inventario</p>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="usuarioActual" style="color: rgba(255,255,255,0.8); font-size: 0.9em;"></span>
                    <button class="admin-btn" onclick="abrirAdmin()">
                        ‚öôÔ∏è Admin
                    </button>
                    <button class="admin-btn" onclick="cerrarSesion()" style="background: rgba(231,76,60,0.3); border-color: rgba(231,76,60,0.5);">
                        üö™ Salir
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Modal Admin -->
    <div id="adminModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2>‚öôÔ∏è Panel de Administraci√≥n</h2>
                <button class="admin-modal-close" onclick="cerrarAdmin()">√ó</button>
            </div>
            <div class="admin-modal-body">
                <div class="admin-tabs">
                    <button class="admin-tab active" onclick="switchAdminTab('config', event)">üè∑Ô∏è Configuraci√≥n</button>
                    <button class="admin-tab" onclick="switchAdminTab('datos', event)">üóÉÔ∏è Datos</button>
                    <button class="admin-tab" onclick="switchAdminTab('backups', event)">üíæ Backups</button>
                </div>

                <!-- Tab Configuraci√≥n -->
                <div id="adminConfig" class="admin-tab-content active">
                    <div class="app-name-section">
                        <label>Nombre de la aplicaci√≥n</label>
                        <input type="text" id="inputAppName" placeholder="Ej: Mi Tienda">
                        <button onclick="guardarNombreApp()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üíæ Guardar nombre
                        </button>
                    </div>
                </div>

                <!-- Tab Gesti√≥n de Datos -->
                <div id="adminDatos" class="admin-tab-content">
                    <div style="margin-bottom: 20px;">
                        <strong>Gesti√≥n de Datos</strong>
                        <p style="color: #666; font-size: 0.9em; margin-top: 4px;">Elimin√° datos espec√≠ficos sin afectar el resto. Siempre se crea un backup antes de borrar.</p>
                    </div>
                    
                    <div id="datosStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <!-- Se llena con JS -->
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 15px; color: #333;">üóëÔ∏è Limpiar Ventas por Per√≠odo</h4>
                        <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                            <div>
                                <label style="display: block; font-size: 0.85em; margin-bottom: 5px;">Mes</label>
                                <select id="limpiarMes" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12" selected>Diciembre</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85em; margin-bottom: 5px;">A√±o</label>
                                <input type="number" id="limpiarAnio" value="2025" min="2020" max="2030" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 80px;">
                            </div>
                            <button onclick="limpiarVentasMes()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                üóëÔ∏è Eliminar ventas del mes
                            </button>
                        </div>
                        <div id="resultadoLimpiarMes" style="margin-top: 10px;"></div>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffc107;">
                        <h4 style="margin-bottom: 10px; color: #856404;">‚ö†Ô∏è Zona de peligro</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="limpiarTabla('ventas')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                                Borrar TODAS las ventas
                            </button>
                            <button onclick="limpiarTabla('cambios')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                                Borrar TODOS los cambios
                            </button>
                            <button onclick="limpiarTabla('cuentas')" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                                Borrar TODAS las cuentas corrientes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tab Backups -->
                <div id="adminBackups" class="admin-tab-content">
                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Historial de cambios</strong>
                            <p style="color: #666; font-size: 0.9em; margin-top: 4px;">Cada acci√≥n genera un backup autom√°tico. Pod√©s restaurar a cualquier punto anterior.</p>
                        </div>
                        <button onclick="cargarBackups()" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">
                            üîÑ Actualizar
                        </button>
                    </div>
                    <div id="backupLog" class="backup-log">
                        <div class="backup-empty">Cargando backups...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- NAVEGACI√ìN TABS -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('busqueda', event)">üîç Buscar Precios</button>
            <button class="tab-btn" onclick="switchTab('cajas', event)">üìä Cajas Diarias</button>
            <button class="tab-btn" onclick="switchTab('stock', event)">üì¶ Stock</button>
            <button class="tab-btn" onclick="switchTab('cuentas', event)">üí∞ Cuentas Corrientes</button>
            <button class="tab-btn" onclick="switchTab('cambios', event)">üîÑ Cambios</button>
            <button class="tab-btn" onclick="switchTab('historico', event)">Hist√≥rico de Ventas</button>
        </div>

        <!-- ==================== TAB 1: B√öSQUEDA ====================-->
        <div id="busqueda" class="tab-content active">
            <div class="card">
                <h2>Buscar Producto por C√≥digo</h2>
                <div class="form-group input-search">
                    <input type="text" id="busquedaInput" placeholder="Buscar por c√≥digo o descripci√≥n..." autofocus>
                    <span class="search-icon">üîç</span>
                </div>
                <div id="busquedaResultado"></div>
            </div>
        </div>

        <!-- TAB 2 CAJAS DIARIAS -->
<div id="cajas" class="tab-content">

<!-- Selector de mes y d√≠as -->
    <div style="margin-top: 40px; margin-bottom: 20px;">
        <h3 id="mesActualTitulo" style="color: #333; margin-bottom: 15px;"></h3>
        <div id="diasDelMes" class="dias-grid"></div>
    </div>

  <!-- BOX MODO OSCURO: Registro de Venta -->
    <div class="venta-box-dark">
        <h3 class="venta-box-title">üíº Registrar Nueva Venta</h3>
        
        <!-- B√∫squeda r√°pida -->
        <div class="search-box">
            <input type="text" id="busquedaRapida" class="search-input-dark" placeholder="üîç Buscar por c√≥digo o descripci√≥n...">
            <div id="resultadoRapido"></div>
        </div>

        <!-- Formulario de venta en l√≠nea -->
        <div class="venta-form-inline">
            <div class="form-field">
                <label>Fecha</label>
                <input type="date" id="fecha" required>
            </div>

            <div class="form-field">
                <label>Art√≠culo</label>
                <input type="text" id="articulo" placeholder="C√≥digo" required>
            </div>

            <div class="form-field">
                <label>Cantidad</label>
                <input type="number" id="cantidad" value="1" min="1" required>
            </div>

            <div class="form-field">
                <label>Precio</label>
                <input type="number" id="precio" step="0.01" placeholder="0.00" required>
            </div>

            <div class="form-field">
                <label>Descuento</label>
                <select id="descuento">
                    <option value="0">0%</option>
                    <option value="5">5%</option>
                    <option value="10">10%</option>
                    <option value="15">15%</option>
                    <option value="20">20%</option>
                    <option value="25">25%</option>
                    <option value="30">30%</option>
                    <option value="35">35%</option>
                    <option value="40">40%</option>
                    <option value="45">45%</option>
                    <option value="50">50%</option>
                </select>
            </div>

            <div class="form-field total-field">
                <label>Total a cobrar</label>
                <div id="totalACobrar" class="total-display">$0.00</div>
            </div>

            <div class="form-field">
                <label>Categor√≠a</label>
                <input type="text" id="categoria" placeholder="Auto" readonly>
            </div>

            <div class="form-field">
                <label>Factura</label>
                <div class="factura-select">
                    <button type="button" class="factura-btn active" data-value="A">A</button>
                    <button type="button" class="factura-btn" data-value="B">B</button>
                </div>
            </div>

            <div class="form-field">
                <label>Tipo Pago</label>
                <select id="tipoPago">
                    <option value="otro" selected>Otro...</option>
                    <option value="CDNI">CDNI</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="MODO">MODO</option>
                    <option value="QR">QR</option>
                    <option value="MP">MP</option>
                    <option value="Tarjeta Cr√©dito">Tarjeta Cr√©dito</option>
                    <option value="Tarjeta D√©bito">Tarjeta D√©bito</option>
                    <option value="GETNET">GETNET</option>
                    <option value="Promo">Promo</option>
                    <option value="Cheque">Cheque</option>
                    <option value="Efectivo">Efectivo</option>
                </select>
            </div>

            <div class="form-field">
                <label>Comentarios</label>
                <input type="text" id="comentarios" placeholder="Opcional">
            </div>
        </div>

        <!-- Tipo de pago personalizado -->
        <div id="otroTipoPagoContainer" style="margin-bottom: 15px;">
            <input type="text" id="otroTipoPago" placeholder="Especificar tipo de pago..." style="padding: 8px; width: 300px; border: 1px solid #444; border-radius: 4px; background: #2a2a2a; color: white;">
        </div>

        <button class="btn-registrar-dark" onclick="registrarVenta(event)">‚úì Registrar Venta</button>
    </div>

    <!-- Lista de ventas del d√≠a seleccionado -->
    <div class="ventas-list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 id="ventasDiaTitulo" style="margin: 0;">Ventas del d√≠a</h3>
            <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 8px;">
                <label style="color: #000000; font-size: 0.9em; margin: 0;">Caja inicial:</label>
                <input type="text" id="cajaInicial" placeholder="$0" 
                    style="width: 120px; padding: 6px 10px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.2); color: white; text-align: right; font-weight: bold;"
                    onblur="guardarCajaInicial()" 
                    onkeyup="formatearInputMoneda(this); if(event.key === 'Enter') { this.blur(); }">
            </div>
        </div>
        <div id="listaVentas"></div>
    </div>
</div>

<!-- ==================== TAB CAMBIOS ==================== -->
<div id="cambios" class="tab-content">
    <div class="card">
        <h2>üîÑ Registrar Cambio de Art√≠culo</h2>
        
        <div class="venta-box-dark">
            <div class="form-field" style="margin-bottom: 20px;">
                <label style="color: #ecf0f1;">Fecha del cambio</label>
                <input type="date" id="cambioFecha" class="search-input-dark" style="max-width: 200px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Art√≠culo que DEVUELVEN -->
                <div class="cambio-section">
                    <div class="cambio-section-title">üì• Art√≠culo que devuelven</div>
                    <div class="search-box">
                        <input type="text" id="cambioArticuloDevuelto" class="search-input-dark" placeholder="C√≥digo del art√≠culo...">
                    </div>
                    <div id="cambioInfoDevuelto" class="cambio-producto-info" style="display: none;"></div>
                </div>

                <!-- Art√≠culo que SE LLEVAN -->
                <div class="cambio-section">
                    <div class="cambio-section-title nuevo">üì§ Art√≠culo que se llevan</div>
                    <div class="search-box">
                        <input type="text" id="cambioArticuloNuevo" class="search-input-dark" placeholder="C√≥digo del art√≠culo...">
                    </div>
                    <div id="cambioInfoNuevo" class="cambio-producto-info" style="display: none;"></div>
                </div>
            </div>

            <!-- Resumen del cambio -->
            <div id="cambioResumen" class="cambio-resumen" style="display: none;">
                <div class="cambio-mensaje" id="cambioMensaje"></div>
                <div class="cambio-diferencia" id="cambioDiferencia"></div>
                
                <!-- Opciones de pago (solo si debe pagar) -->
                <div id="cambioOpcionesPago" style="display: none; margin-top: 15px;">
                    <div class="venta-form-inline" style="justify-content: center; gap: 15px;">
                        <div class="form-field" style="min-width: 120px;">
                            <label>Factura</label>
                            <div class="factura-select">
                                <button type="button" class="factura-btn cambio-factura active" data-value="A">A</button>
                                <button type="button" class="factura-btn cambio-factura" data-value="B">B</button>
                            </div>
                        </div>
                        <div class="form-field" style="min-width: 150px;">
                            <label>Tipo Pago</label>
                            <select id="cambioTipoPago" style="background: #2a2a2a; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px;">
                                <option value="CDNI">CDNI</option>
                                <option value="Transferencia">Transferencia</option>
                                <option value="MODO">MODO</option>
                                <option value="QR">QR</option>
                                <option value="MP">MP</option>
                                <option value="Tarjeta Cr√©dito">Tarjeta Cr√©dito</option>
                                <option value="Tarjeta D√©bito">Tarjeta D√©bito</option>
                                <option value="GETNET">GETNET</option>
                                <option value="Efectivo">Efectivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Mensaje informativo si hay saldo a favor -->
                <div id="cambioInfoSaldoFavor" style="display: none; margin-top: 15px; padding: 10px; background: rgba(231, 76, 60, 0.2); border-radius: 6px;">
                    <span style="color: #e74c3c;">üí° Si el cliente quiere usar su saldo a favor despu√©s, pod√©s crear su cuenta corriente desde el bot√≥n üí∞ en la tabla de abajo.</span>
                </div>

                <div class="form-field" style="margin-top: 15px;">
                    <label style="color: #ecf0f1;">Comentarios</label>
                    <input type="text" id="cambioComentarios" class="search-input-dark" placeholder="Opcional" style="max-width: 400px; margin: 0 auto;">
                </div>
            </div>

            <button id="btnRegistrarCambio" class="btn-registrar-dark" onclick="registrarCambio()" style="display: none; margin-top: 20px;">üîÑ Registrar Cambio</button>
        </div>
    </div>

    <!-- Historial de cambios -->
    <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2>üìã Historial de Cambios</h2>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label>Filtrar:</label>
                <input type="month" id="filtroMesCambios" class="form-control" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                <button onclick="cargarCambios()" class="btn" style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Filtrar</button>
            </div>
        </div>
        
        <div id="tablaCambiosContainer">
            <table class="tabla-cambios" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Fecha</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Devuelto</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Nuevo</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Precio Dev.</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Precio Nuevo</th>
                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Diferencia</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Comentarios</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="tablaCambiosBody">
                    <tr><td colspan="8" style="padding: 20px; text-align: center; color: #888;">Cargando cambios...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Resumen estad√≠sticas -->
        <div id="cambiosStats" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #3498db;" id="statTotalCambios">0</div>
                    <div style="color: #666; font-size: 0.9em;">Total cambios</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #27ae60;" id="statDiferenciaPositiva">$0</div>
                    <div style="color: #666; font-size: 0.9em;">Cobrado (diferencias +)</div>
                </div>
                <div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #e74c3c;" id="statDiferenciaNegativa">$0</div>
                    <div style="color: #666; font-size: 0.9em;">A favor clientes (-)</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-------------- TAB 3 STOCK ---------------->
<div id="stock" class="tab-content">
    <div class="card">
        <h2>Actualizar Stock y Precios</h2>

        <!-- BOX OSCURO: b√∫squeda + edici√≥n -->
        <div class="stock-box-dark">

            <!-- B√∫squeda por c√≥digo -->
            <div class="form-group">
                <label>Buscar por c√≥digo de art√≠culo</label>
                <div class="input-search">
                    <input type="text" id="stockBusquedaCodigo" placeholder="Buscar por c√≥digo o descripci√≥n...">
                    <span class="search-icon">üîç</span>
                </div>
                <div id="stockBusquedaResultado" class="error-text" style="display:none;"></div>
            </div>

            <!-- Panel de edici√≥n de producto -->
            <div id="stockEditor" class="stock-editor" style="display:none;">
                <h3 id="stockProductoTitulo"></h3>

                <div class="stock-editor-grid">
                    <div class="stock-field">
                        <label>C√≥digo</label>
                        <div id="stockCodigo" class="stock-value"></div>
                    </div>
                    <div class="stock-field">
                        <label>Categor√≠a</label>
                        <div id="stockCategoria" class="stock-value"></div>
                    </div>
                    <div class="stock-field">
                        <label>Precio P√∫blico</label>
                        <input type="number" id="stockPrecioPublico" step="0.01">
                    </div>
                    <div class="stock-field">
                        <label>Costo</label>
                        <input type="number" id="stockCosto" step="0.01">
                    </div>
                    <div class="stock-field">
                        <label>Stock actual</label>
                        <div id="stockActual" class="stock-value"></div>
                    </div>
                    <div class="stock-field">
                        <label>Cantidad a agregar / sacar</label>
                        <input type="number" id="stockDelta" step="1" value="0">
                    </div>
                    <div class="stock-field">
                        <label>Stock final</label>
                        <div id="stockFinal" class="stock-value"></div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="guardarStockYPrecios()">üíæ Guardar cambios</button>
                <div id="stockEditorMensaje" class="error-text" style="margin-top:10px; display:none;"></div>
            </div>
        </div> <!-- /stock-box-dark -->

        <hr style="margin: 30px 0;">

        <!-- BOX CLARO: resumen + listado -->
        <div class="stock-box-light">
            <!-- Resumen de stock -->
            <div class="stock-resumen-top">
    <h3>Detalle de stock total</h3>
    <div id="stockResumenTotal" class="stock-resumen-total"></div>
</div>
<div id="stockResumen" class="stock-resumen"></div>

            <!-- Filtros y tabla de productos -->
            <div class="stock-list-header">
                <h3>Listado completo de art√≠culos</h3>
                <div class="stock-filtros">
                    <select id="filtroCategoria">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                    <input type="text" id="filtroTexto" placeholder="Filtrar por descripci√≥n o c√≥digo...">
                </div>
            </div>

            <div class="stock-tabla-wrapper">
                <table class="stock-tabla" id="stockTabla">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Categor√≠a</th>
                            <th class="num">Precio P√∫blico</th>
                            <th class="num">Costo</th>
                            <th class="num">Stock</th>
                        </tr>
                    </thead>
                    <tbody id="stockTablaBody">
                        <!-- filas din√°micas -->
                    </tbody>
                </table>
            </div>
        </div> <!-- /stock-box-light -->

        <!-- BOX PEQUE√ëO: importar/actualizar productos por CSV -->
        <div class="stock-box-csv">
            <h3>üì¶ Importar Productos CSV</h3>
            <p class="stock-csv-text">
                <strong>Primera vez:</strong> Carg√° tu archivo con todos los productos.<br>
                Formato: <code>codigo,descripcion,categoria,precioPublico,costo,stock</code>
            </p>

            <div class="upload-area" onclick="document.getElementById('csvProductos').click()">
                <div class="icon">üìÅ</div>
                <p><strong>Click para importar productos</strong></p>
                <p style="font-size: 0.9em; color: #999; margin-top: 10px;">
                    Crea productos nuevos o actualiza existentes
                </p>
                <input type="file" id="csvProductos" accept=".csv" onchange="importarProductosCSV()" style="display:none;">
            </div>
            <div id="alertaProductos" class="alert"></div>

            <hr style="margin: 20px 0; border: none; border-top: 1px dashed #ddd;">

            <h3>üîÑ Actualizar Solo Stock</h3>
            <p class="stock-csv-text">
                Usa esta opci√≥n para actualizar cantidades de productos existentes.
                Formato: <code>codigo,cantidad</code>
            </p>

            <div class="upload-area" onclick="document.getElementById('csvFile').click()">
                <div class="icon">üìä</div>
                <p><strong>Click para actualizar stock</strong></p>
                <p style="font-size: 0.9em; color: #999; margin-top: 10px;">
                    Solo actualiza cantidades, no crea productos nuevos
                </p>
                <input type="file" id="csvFile" accept=".csv" onchange="uploadCSV()">
            </div>

            <div id="alertaStock" class="alert"></div>
            <div id="resultadoStock"></div>
        </div> <!-- /stock-box-csv -->
    </div> <!-- /card -->
</div> <!-- /tab-content stock -->


        <!-- ==================== TAB 4: CUENTAS CORRIENTES ====================-->
<div id="cuentas" class="tab-content">
    <div class="card">
        <h2>Cuentas Corrientes</h2>
        
        <!-- Formulario para nueva cuenta -->
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px; font-size: 1.2em;">‚ûï Nueva Cuenta</h3>
            <div style="display: flex; gap: 10px; align-items: end;">
                <div class="form-field" style="flex: 1;">
                    <label>Nombre del Cliente</label>
                    <input type="text" id="cuentasCliente" placeholder="Ej: Juan P√©rez">
                </div>
                <button class="btn-registrar" onclick="crearCuenta()" style="height: 40px;">Crear Cuenta</button>
            </div>
        </div>

        <div id="alertaCuentas" class="alert"></div>

        <!-- Mini tabs internos -->
        <div class="mini-tabs">
            <button class="mini-tab active" onclick="switchCuentasTab('activas', event)">Cuentas Activas</button>
            <button class="mini-tab" onclick="switchCuentasTab('saldadas', event)">Cuentas Saldadas</button>
        </div>

        <!-- Grid de cuentas activas -->
        <div id="cuentasActivas" class="cuentas-tab-content active">
            <div id="cuentasGridActivas"></div>
        </div>

        <!-- Grid de cuentas saldadas -->
        <div id="cuentasSaldadas" class="cuentas-tab-content">
            <div id="cuentasGridSaldadas"></div>
        </div>

        <!-- Totales generales -->
        <div id="totalesCuentas"></div>
    </div>
</div>

<!-------------- TAB 5 HIST√ìRICO ---------------->
<div id="historico" class="tab-content">
    <div class="card">
        <h2>Hist√≥rico de Ventas</h2>

        <!-- Filtros de per√≠odo -->
        <div class="historico-filtros">
            <div class="periodo-box">
                <label>Seleccionar a√±o</label>
                <select id="historicoAnio"></select>
            </div>
            <div class="periodo-box">
                <label>Seleccionar meses</label>
                <div class="meses-grid" id="historicoMeses">
                    <!-- botones 12 meses -->
                </div>
            </div>
        </div>

        <!-- M√©tricas principales -->
        <div class="historico-metricas">
            <div class="metric-card">
                <h4>Ventas totales</h4>
                <div class="metric-valor" id="histTotalVentas">$ 0</div>
                <div class="metric-detalle" id="histTotalTickets">0 tickets</div>
            </div>
            <div class="metric-card">
                <h4>Ticket promedio</h4>
                <div class="metric-valor" id="histTicketPromedio">$ 0</div>
                <div class="metric-detalle">por venta</div>
            </div>
            <div class="metric-card">
                <h4>Prendas vendidas</h4>
                <div class="metric-valor" id="histPrendasVendidas">0</div>
                <div class="metric-detalle">unidades</div>
            </div>
            <div class="metric-card" style="border-left: 3px solid #3498db;">
                <h4>Factura A</h4>
                <div class="metric-valor" id="histFacturaAMonto" style="color: #3498db;">$ 0</div>
                <div class="metric-detalle" id="histFacturaACant">0 tickets</div>
            </div>
            <div class="metric-card" style="border-left: 3px solid #e67e22;">
                <h4>Factura B</h4>
                <div class="metric-valor" id="histFacturaBMonto" style="color: #e67e22;">$ 0</div>
                <div class="metric-detalle" id="histFacturaBCant">0 tickets</div>
            </div>
        </div>

        <!-- Lista de ventas del per√≠odo -->
        <div class="historico-seccion">
            <div class="historico-seccion-header">
                <h3>Detalle de ventas <span class="hist-periodo-label" id="histPeriodoLabel">-</span></h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-export" onclick="exportarHistorico('csv')" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <span>üì•</span> CSV
                    </button>
                    <button class="btn-export" onclick="exportarHistorico('excel')" style="background: #217346; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <span>üìä</span> Excel
                    </button>
                    <button id="btnFiltrosTabla" class="btn-toggle-filtros" onclick="toggleFiltrosTabla()">
                        <span class="icono">üîç</span> Filtros
                    </button>
                </div>
            </div>

            <!-- Panel de filtros -->
            <div id="filtrosTablaPanel" class="filtros-panel" style="display: none;">
                <div class="filtros-grid">
                    <div class="filtro-item">
                        <label>Buscar art√≠culo</label>
                        <input type="text" id="filtroArticulo" placeholder="C√≥digo o descripci√≥n..." onkeyup="aplicarFiltrosTabla()">
                    </div>

                    <div class="filtro-item">
                        <label>Categor√≠a</label>
                        <select id="filtroCategoria" onchange="aplicarFiltrosTabla()">
                            <option value="">Todas</option>
                        </select>
                    </div>

                    <div class="filtro-item">
                        <label>Tipo de pago</label>
                        <select id="filtroTipoPago" onchange="aplicarFiltrosTabla()">
                            <option value="">Todos</option>
                        </select>
                    </div>

                    <div class="filtro-item">
                        <label>Monto m√≠nimo</label>
                        <input type="number" id="filtroMontoMin" placeholder="$0" onkeyup="aplicarFiltrosTabla()">
                    </div>

                    <div class="filtro-item">
                        <label>Monto m√°ximo</label>
                        <input type="number" id="filtroMontoMax" placeholder="Sin l√≠mite" onkeyup="aplicarFiltrosTabla()">
                    </div>

                    <div class="filtro-item">
                        <label>Cantidad m√≠nima</label>
                        <input type="number" id="filtroCantidadMin" placeholder="0" onkeyup="aplicarFiltrosTabla()">
                    </div>
                </div>

                <div class="filtros-acciones">
                    <button class="btn-limpiar-filtros" onclick="limpiarFiltrosTabla()">
                        Limpiar filtros
                    </button>
                    <span id="filtrosResultado" class="filtros-resultado"></span>
                </div>
            </div>

            <!-- Tabla de ventas -->
            <div class="hist-ventas-wrapper">
                <table class="hist-ventas-tabla">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Art√≠culo</th>
                            <th>Cat.</th>
                            <th class="num">Cant.</th>
                            <th class="num">Precio</th>
                            <th class="num">Desc.</th>
                            <th class="num">Total</th>
                            <th>Pago</th>
                            <th>Fact.</th>
                        </tr>
                    </thead>
                    <tbody id="histVentasBody">
                        <!-- filas din√°micas -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Secci√≥n de an√°lisis visual -->
        <div class="analisis-visual-seccion">
            <div class="analisis-header">
                <h3>üìä An√°lisis visual</h3>
            </div>
            <button class="btn-toggle-graficos" onclick="toggleSeccionGraficos()">
                <span id="iconoGraficos">‚ñº</span> Mostrar gr√°ficos
            </button>

            <div id="seccionGraficos" class="graficos-container" style="display: none;">
                
                <!-- Selector de gr√°ficos -->
                <div class="graficos-selector">
                    <button class="grafico-tab active" data-chart="categorias" onclick="cambiarGrafico('categorias')">
                        üè∑Ô∏è Por categor√≠a
                    </button>
                    <button class="grafico-tab" data-chart="tiempo" onclick="cambiarGrafico('tiempo')">
                        üìà Evoluci√≥n temporal
                    </button>
                    <button class="grafico-tab" data-chart="pagos" onclick="cambiarGrafico('pagos')">
                        üí≥ M√©todos de pago
                    </button>
                    <button class="grafico-tab" data-chart="productos" onclick="cambiarGrafico('productos')">
                        üèÜ Top productos
                    </button>
                </div>

                <!-- Canvas para los gr√°ficos -->
                <div class="grafico-wrapper">
                    <div id="chartCategorias" class="chart-canvas active"></div>
                    <div id="chartTiempo" class="chart-canvas"></div>
                    <div id="chartPagos" class="chart-canvas"></div>
                    <div id="chartProductos" class="chart-canvas"></div>
                </div>

            </div>
        </div>

        <!-- BOX PEQUE√ëO: importar ventas desde CSV -->
        <div class="ventas-import-box">
            <h3>Importar ventas hist√≥ricas desde CSV</h3>
            <p class="ventas-import-text">
                Usa esta opci√≥n para cargar ventas pasadas desde un archivo CSV.
                Formato esperado: <code>Fecha,Articulo,Cantidad,Precio,Categoria,Factura,Tipo Pago</code>
            </p>

            <div class="upload-area" onclick="document.getElementById('csvVentas').click()">
                <div class="icon">üìÅ</div>
                <p><strong>Haz click o arrastra un archivo CSV</strong></p>
                <p style="font-size: 0.9em; color: #999; margin-top: 10px;">
                    Las fechas deben estar en formato d/m/yyyy (ej: 5/12/2025)
                </p>
                <input type="file" id="csvVentas" accept=".csv" onchange="uploadVentasCSV()">
            </div>

            <div id="alertaVentasCSV" class="alert"></div>
        </div>

    </div> <!-- /card -->
</div> <!-- /historico -->



    <script>
    // ==================== PANEL ADMIN ====================
    function abrirAdmin() {
        document.getElementById('adminModal').classList.add('active');
        cargarConfigAdmin();
        cargarBackups();
    }

    function cerrarAdmin() {
        document.getElementById('adminModal').classList.remove('active');
    }

    // Cerrar modal al hacer click fuera
    document.addEventListener('click', (e) => {
        const modal = document.getElementById('adminModal');
        if (e.target === modal) {
            cerrarAdmin();
        }
    });

    function switchAdminTab(tab, event) {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tab === 'config' ? 'adminConfig' : 'adminBackups').classList.add('active');
        
        if (tab === 'backups') {
            cargarBackups();
        }
    }

    async function cargarConfigAdmin() {
        try {
            const resp = await fetch('/api/config');
            if (resp.ok) {
                const config = await resp.json();
                document.getElementById('inputAppName').value = config.appName || 'AIRBORN';
                actualizarNombreApp(config.appName || 'AIRBORN');
            }
        } catch (error) {
            console.error('Error cargando config:', error);
        }
    }

    async function guardarNombreApp() {
        const nombre = document.getElementById('inputAppName').value.trim();
        if (!nombre) {
            showToast('‚ö†Ô∏è Ingres√° un nombre', 'error');
            return;
        }

        try {
            const resp = await fetch('/api/config/nombre', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre })
            });

            if (resp.ok) {
                actualizarNombreApp(nombre);
                showToast('‚úÖ Nombre actualizado', 'success');
            } else {
                throw new Error('Error al guardar');
            }
        } catch (error) {
            showToast('‚ùå Error al guardar nombre', 'error');
        }
    }

    function actualizarNombreApp(nombre) {
        document.getElementById('appName').textContent = 'üõçÔ∏è ' + nombre.toUpperCase();
        document.title = nombre + ' - Sistema de Inventario';
    }

    async function cargarBackups() {
        const logDiv = document.getElementById('backupLog');
        logDiv.innerHTML = '<div class="backup-empty">Cargando...</div>';

        try {
            const resp = await fetch('/api/backups');
            if (!resp.ok) throw new Error('Error al cargar backups');
            
            const backups = await resp.json();

            if (!backups || backups.length === 0) {
                logDiv.innerHTML = '<div class="backup-empty">No hay backups registrados a√∫n.<br>Se crear√°n autom√°ticamente al realizar acciones.</div>';
                return;
            }

            logDiv.innerHTML = backups.map(b => `
                <div class="backup-item">
                    <div class="backup-info">
                        <div class="backup-date">üìÖ ${formatBackupDate(b.fecha)}</div>
                        <div class="backup-action">${b.accion}</div>
                        ${b.detalle ? `<div class="backup-detail">${b.detalle}</div>` : ''}
                    </div>
                    <button class="backup-restore-btn" onclick="restaurarBackup('${b.archivo}', '${b.accion.replace(/'/g, "\\'")}')">
                        üîÑ Restaurar
                    </button>
                </div>
            `).join('');

        } catch (error) {
            console.error('Error cargando backups:', error);
            logDiv.innerHTML = '<div class="backup-empty" style="color: #e74c3c;">Error al cargar backups</div>';
        }
    }

    function formatBackupDate(fechaStr) {
        // Formato: 2025-12-29_13-45-22
        const [fecha, hora] = fechaStr.split('_');
        const [year, month, day] = fecha.split('-');
        const [h, m, s] = hora.split('-');
        return `${day}/${month}/${year} ${h}:${m}:${s}`;
    }

    async function restaurarBackup(archivo, accion) {
        if (!confirm(`¬øRestaurar al punto anterior?\n\n"${accion}"\n\n‚ö†Ô∏è Esto revertir√° todos los cambios realizados despu√©s de este punto.\n\nüìå Despu√©s deber√°s reiniciar el servidor.`)) {
            return;
        }

        try {
            const resp = await fetch('/api/backups/restaurar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ archivo })
            });

            const data = await resp.json();

            if (!resp.ok) {
                throw new Error(data.error || 'Error al restaurar');
            }

            if (data.requiereReinicio) {
                // Mostrar modal de instrucciones
                cerrarAdmin();
                alert('‚úÖ Backup preparado para restaurar.\n\nüìå Para completar la restauraci√≥n:\n\n1. Cerr√° esta ventana\n2. And√° a la consola del servidor\n3. Presion√° Ctrl+C para detenerlo\n4. Ejecut√°: node server.js\n5. Recarg√° esta p√°gina');
            } else {
                showToast('‚úÖ Base de datos restaurada. Recargando...', 'success');
                setTimeout(() => location.reload(), 1500);
            }

        } catch (error) {
            console.error('Error restaurando backup:', error);
            showToast(`‚ùå ${error.message}`, 'error');
        }
    }

    // Cerrar sesi√≥n
    async function cerrarSesion() {
        if (!confirm('¬øCerrar sesi√≥n?')) return;
        
        try {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login.html';
        } catch (error) {
            console.error('Error cerrando sesi√≥n:', error);
            window.location.href = '/login.html';
        }
    }

    // Verificar sesi√≥n y cargar datos al iniciar
    window.addEventListener('load', async () => {
        try {
            // Verificar si est√° logueado
            const sessionResp = await fetch('/api/session');
            const sessionData = await sessionResp.json();
            
            if (!sessionData.logueado) {
                window.location.href = '/login.html';
                return;
            }
            
            // Mostrar usuario actual
            document.getElementById('usuarioActual').textContent = `üë§ ${sessionData.usuario}`;
            
            // Cargar configuraci√≥n
            const configResp = await fetch('/api/config');
            if (configResp.ok) {
                const config = await configResp.json();
                if (config.appName) {
                    actualizarNombreApp(config.appName);
                }
            }
        } catch (e) {
            console.log('Error verificando sesi√≥n:', e);
            window.location.href = '/login.html';
        }
    });

    // ==================== FUNCIONES GENERALES ====================
    function switchTab(tab, ev) {
    // Ocultar todos los tabs
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

    // Mostrar tab seleccionado
    document.getElementById(tab).classList.add('active');
    if (ev && ev.target) ev.target.classList.add('active');

    // Cargar datos cuando necesario
    if (tab === 'cajas') cargarVentasDelMes();
    if (tab === 'cuentas') cargarCuentas();
    if (tab === 'stock') cargarStockCompleto();
    if (tab === 'cambios') {
        document.getElementById('cambioFecha').valueAsDate = new Date();
        // Set default filter to current month
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('filtroMesCambios').value = currentMonth;
        cargarCambios();
    }
}

    function showAlert(elementId, message, type = 'success') {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = `alert ${type === 'success' ? 'alert-success' : type === 'danger' ? 'alert-danger' : 'alert-warning'} show`;
        setTimeout(() => el.classList.remove('show'), 5000);
    }

    function formatMoney(num) {
    const n = Number(num);
    if (!isFinite(n)) return '$0,00';
    
    // Separar parte entera y decimal
    const [entero, decimal = '00'] = n.toFixed(2).split('.');
    
    // Formatear parte entera con puntos para miles
    const enteroFormateado = entero.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    // Retornar con formato argentino: $1.234,56
    return '$' + enteroFormateado + ',' + decimal;
}

function formatPercentage(num) {
    return num.toFixed(1).replace('.', ',');
}

// ==================== TABS VENTA/CAMBIO ====================
function switchVentaCambioTab(tab, event) {
    document.querySelectorAll('.venta-cambio-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.venta-cambio-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab === 'venta' ? 'tabVenta' : 'tabCambio').classList.add('active');
    
    // Inicializar fecha del cambio si es ese tab
    if (tab === 'cambio') {
        document.getElementById('cambioFecha').valueAsDate = new Date();
    }
}

// ==================== L√ìGICA DE CAMBIOS ====================
let cambioDevuelto = null;
let cambioNuevo = null;

// Buscar art√≠culo devuelto
document.getElementById('cambioArticuloDevuelto')?.addEventListener('input', async function() {
    const codigo = this.value.trim();
    const infoDiv = document.getElementById('cambioInfoDevuelto');
    
    if (codigo.length < 3) {
        infoDiv.style.display = 'none';
        cambioDevuelto = null;
        actualizarResumenCambio();
        return;
    }
    
    try {
        const response = await fetch(`/api/productos/buscar?codigo=${encodeURIComponent(codigo)}`);
        if (response.ok) {
            cambioDevuelto = await response.json();
            infoDiv.innerHTML = `
                <div class="info-item">
                    <div class="info-label">C√≥digo</div>
                    <div class="info-value">${cambioDevuelto.codigo}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Descripci√≥n</div>
                    <div class="info-value">${cambioDevuelto.descripcion || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Precio</div>
                    <div class="info-value" style="color: #e74c3c;">${formatMoney(cambioDevuelto.precioPublico)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Stock actual</div>
                    <div class="info-value">${cambioDevuelto.stock}</div>
                </div>
            `;
            infoDiv.style.display = 'grid';
        } else {
            infoDiv.innerHTML = '<div style="color: #e74c3c; padding: 10px;">Producto no encontrado</div>';
            infoDiv.style.display = 'block';
            cambioDevuelto = null;
        }
    } catch (error) {
        console.error('Error buscando producto:', error);
        cambioDevuelto = null;
    }
    actualizarResumenCambio();
});

// Buscar art√≠culo nuevo
document.getElementById('cambioArticuloNuevo')?.addEventListener('input', async function() {
    const codigo = this.value.trim();
    const infoDiv = document.getElementById('cambioInfoNuevo');
    
    if (codigo.length < 3) {
        infoDiv.style.display = 'none';
        cambioNuevo = null;
        actualizarResumenCambio();
        return;
    }
    
    try {
        const response = await fetch(`/api/productos/buscar?codigo=${encodeURIComponent(codigo)}`);
        if (response.ok) {
            cambioNuevo = await response.json();
            infoDiv.innerHTML = `
                <div class="info-item">
                    <div class="info-label">C√≥digo</div>
                    <div class="info-value">${cambioNuevo.codigo}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Descripci√≥n</div>
                    <div class="info-value">${cambioNuevo.descripcion || '-'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Precio</div>
                    <div class="info-value" style="color: #27ae60;">${formatMoney(cambioNuevo.precioPublico)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Stock actual</div>
                    <div class="info-value">${cambioNuevo.stock}</div>
                </div>
            `;
            infoDiv.style.display = 'grid';
        } else {
            infoDiv.innerHTML = '<div style="color: #e74c3c; padding: 10px;">Producto no encontrado</div>';
            infoDiv.style.display = 'block';
            cambioNuevo = null;
        }
    } catch (error) {
        console.error('Error buscando producto:', error);
        cambioNuevo = null;
    }
    actualizarResumenCambio();
});

function actualizarResumenCambio() {
    const resumenDiv = document.getElementById('cambioResumen');
    const btnRegistrar = document.getElementById('btnRegistrarCambio');
    const opcionesPago = document.getElementById('cambioOpcionesPago');
    
    if (!cambioDevuelto || !cambioNuevo) {
        resumenDiv.style.display = 'none';
        btnRegistrar.style.display = 'none';
        return;
    }
    
    const precioDevuelto = cambioDevuelto.precioPublico || 0;
    const precioNuevo = cambioNuevo.precioPublico || 0;
    const diferencia = precioNuevo - precioDevuelto;
    
    const mensajeDiv = document.getElementById('cambioMensaje');
    const diferenciaDiv = document.getElementById('cambioDiferencia');
    const infoSaldoFavor = document.getElementById('cambioInfoSaldoFavor');
    
    resumenDiv.style.display = 'block';
    btnRegistrar.style.display = 'block';
    
    if (diferencia > 0) {
        // Cliente debe pagar
        mensajeDiv.textContent = 'El cliente debe abonar la diferencia:';
        diferenciaDiv.textContent = formatMoney(diferencia);
        diferenciaDiv.className = 'cambio-diferencia cobrar';
        opcionesPago.style.display = 'block';
        infoSaldoFavor.style.display = 'none';
    } else if (diferencia < 0) {
        // Saldo a favor del cliente
        mensajeDiv.textContent = 'El cliente tiene saldo a favor:';
        diferenciaDiv.textContent = formatMoney(Math.abs(diferencia));
        diferenciaDiv.className = 'cambio-diferencia favor';
        opcionesPago.style.display = 'none';
        infoSaldoFavor.style.display = 'block';
    } else {
        // Sin diferencia
        mensajeDiv.textContent = 'Cambio sin diferencia de precio';
        diferenciaDiv.textContent = '$0,00';
        diferenciaDiv.className = 'cambio-diferencia neutro';
        opcionesPago.style.display = 'none';
        infoSaldoFavor.style.display = 'none';
    }
}

// Toggle factura en cambios
document.querySelectorAll('.cambio-factura').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.cambio-factura').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
    });
});

async function registrarCambio() {
    if (!cambioDevuelto || !cambioNuevo) {
        showToast('‚ö†Ô∏è Selecciona ambos art√≠culos', 'error');
        return;
    }
    
    const fecha = document.getElementById('cambioFecha').value;
    if (!fecha) {
        showToast('‚ö†Ô∏è Selecciona la fecha', 'error');
        return;
    }
    
    const precioDevuelto = cambioDevuelto.precioPublico || 0;
    const precioNuevo = cambioNuevo.precioPublico || 0;
    const diferencia = precioNuevo - precioDevuelto;
    const comentarios = document.getElementById('cambioComentarios').value.trim();
    
    const btnRegistrar = document.getElementById('btnRegistrarCambio');
    const textoOriginal = btnRegistrar.innerHTML;
    btnRegistrar.disabled = true;
    btnRegistrar.innerHTML = 'Procesando... <span class="loading-spinner"></span>';
    
    try {
        // 1. Devolver stock del art√≠culo devuelto (sumar)
        const respDevolver = await fetch(`/api/productos/${encodeURIComponent(cambioDevuelto.codigo)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                precioPublico: cambioDevuelto.precioPublico,
                costo: cambioDevuelto.costo,
                stockFinal: cambioDevuelto.stock + 1
            })
        });
        
        if (!respDevolver.ok) {
            throw new Error('Error al devolver stock del art√≠culo');
        }
        
        // 2. Descontar stock del art√≠culo nuevo (restar)
        const respNuevo = await fetch(`/api/productos/${encodeURIComponent(cambioNuevo.codigo)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                precioPublico: cambioNuevo.precioPublico,
                costo: cambioNuevo.costo,
                stockFinal: cambioNuevo.stock - 1
            })
        });
        
        if (!respNuevo.ok) {
            throw new Error('Error al descontar stock del art√≠culo nuevo');
        }
        
        // 3. Registrar el cambio en la tabla de cambios
        const respCambio = await fetch('/api/cambios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                fecha,
                articuloDevuelto: cambioDevuelto.codigo,
                articuloNuevo: cambioNuevo.codigo,
                precioDevuelto,
                precioNuevo,
                diferencia,
                comentarios
            })
        });
        
        if (!respCambio.ok) {
            console.warn('No se pudo registrar en tabla de cambios (puede que no exista el endpoint)');
        }
        
        // 4. Si hay diferencia a cobrar, registrar como venta
        if (diferencia > 0) {
            const facturaBtn = document.querySelector('.cambio-factura.active');
            const tipoPago = document.getElementById('cambioTipoPago').value;
            
            const ventaResp = await fetch('/api/ventas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha,
                    articulo: cambioNuevo.codigo,
                    cantidad: 0, // No afecta stock, ya lo ajustamos
                    precio: diferencia,
                    descuento: 0,
                    categoria: cambioNuevo.categoria || '',
                    factura: facturaBtn?.dataset.value || 'A',
                    tipoPago,
                    comentarios: `CAMBIO: ${cambioDevuelto.codigo} ‚Üí ${cambioNuevo.codigo}. ${comentarios}`
                })
            });
            
            if (!ventaResp.ok) {
                console.warn('No se pudo registrar la diferencia como venta');
            }
        }
        
        // √âxito
        showToast('‚úÖ Cambio registrado correctamente', 'success');
        
        // Limpiar formulario
        document.getElementById('cambioArticuloDevuelto').value = '';
        document.getElementById('cambioArticuloNuevo').value = '';
        document.getElementById('cambioInfoDevuelto').style.display = 'none';
        document.getElementById('cambioInfoNuevo').style.display = 'none';
        document.getElementById('cambioResumen').style.display = 'none';
        document.getElementById('btnRegistrarCambio').style.display = 'none';
        document.getElementById('cambioComentarios').value = '';
        cambioDevuelto = null;
        cambioNuevo = null;
        
        // Recargar tabla de cambios
        cargarCambios();
        
    } catch (error) {
        console.error('Error en registrarCambio:', error);
        showToast(`‚ùå ${error.message}`, 'error');
    } finally {
        btnRegistrar.disabled = false;
        btnRegistrar.innerHTML = textoOriginal;
    }
}

// ==================== CARGAR Y MOSTRAR CAMBIOS ====================
async function cargarCambios() {
    const filtroMes = document.getElementById('filtroMesCambios')?.value;
    let url = '/api/cambios';
    
    if (filtroMes) {
        const [year, month] = filtroMes.split('-');
        const desde = `${year}-${month}-01`;
        const hasta = `${year}-${month}-31`;
        url = `/api/cambios/reporte?desde=${desde}&hasta=${hasta}`;
    }
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        const cambios = data.cambios || data;
        const stats = data.stats;
        
        const tbody = document.getElementById('tablaCambiosBody');
        
        if (!cambios || cambios.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: #888;">No hay cambios registrados</td></tr>';
            document.getElementById('cambiosStats').style.display = 'none';
            return;
        }
        
        tbody.innerHTML = cambios.map(c => `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px;">${formatFecha(c.fecha)}</td>
                <td style="padding: 12px; font-family: monospace;">${c.articuloDevuelto}</td>
                <td style="padding: 12px; font-family: monospace;">${c.articuloNuevo}</td>
                <td style="padding: 12px; text-align: right;">${formatMoney(c.precioDevuelto)}</td>
                <td style="padding: 12px; text-align: right;">${formatMoney(c.precioNuevo)}</td>
                <td style="padding: 12px; text-align: right; font-weight: bold; color: ${c.diferencia > 0 ? '#27ae60' : c.diferencia < 0 ? '#e74c3c' : '#f39c12'};">
                    ${c.diferencia > 0 ? '+' : ''}${formatMoney(c.diferencia)}
                </td>
                <td style="padding: 12px; color: #666; font-size: 0.9em;">${c.comentarios || '-'}</td>
                <td style="padding: 12px; text-align: center; white-space: nowrap;">
                    ${c.diferencia < 0 ? `
                        <button onclick="crearCCdesdeCambio(${c.id}, ${Math.abs(c.diferencia)}, '${c.fecha}', '${c.articuloDevuelto}', '${c.articuloNuevo}')" 
                                style="background: #f39c12; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;"
                                title="Crear cuenta corriente con saldo a favor">üí∞</button>
                    ` : ''}
                    <button onclick="eliminarCambio(${c.id}, '${c.articuloDevuelto}', '${c.articuloNuevo}')" 
                            style="background: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;"
                            title="Eliminar cambio">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');
        
        // Mostrar estad√≠sticas si hay
        if (stats) {
            document.getElementById('statTotalCambios').textContent = stats.totalCambios;
            document.getElementById('statDiferenciaPositiva').textContent = formatMoney(stats.diferenciaPositiva);
            document.getElementById('statDiferenciaNegativa').textContent = formatMoney(stats.diferenciaNegativa);
            document.getElementById('cambiosStats').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error cargando cambios:', error);
        document.getElementById('tablaCambiosBody').innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: #e74c3c;">Error al cargar cambios</td></tr>';
    }
}

function formatFecha(fecha) {
    if (!fecha) return '-';
    const [year, month, day] = fecha.split('-');
    return `${day}/${month}/${year}`;
}

async function eliminarCambio(id, articuloDevuelto, articuloNuevo) {
    if (!confirm(`¬øEliminar este cambio?\n\n${articuloDevuelto} ‚Üí ${articuloNuevo}\n\nSe revertir√°n los cambios de stock.`)) {
        return;
    }
    
    try {
        // 1. Obtener datos del cambio para revertir
        const cambiosResp = await fetch('/api/cambios');
        const cambios = await cambiosResp.json();
        const cambio = cambios.find(c => c.id === id);
        
        if (!cambio) {
            showToast('‚ùå No se encontr√≥ el cambio', 'error');
            return;
        }
        
        // 2. Obtener productos actuales
        const devueltoResp = await fetch(`/api/productos/buscar?codigo=${encodeURIComponent(cambio.articuloDevuelto)}`);
        const nuevoResp = await fetch(`/api/productos/buscar?codigo=${encodeURIComponent(cambio.articuloNuevo)}`);
        
        if (devueltoResp.ok) {
            const devuelto = await devueltoResp.json();
            // Restar 1 del stock del devuelto (revertir la devoluci√≥n)
            await fetch(`/api/productos/${encodeURIComponent(cambio.articuloDevuelto)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    precioPublico: devuelto.precioPublico,
                    costo: devuelto.costo,
                    stockFinal: devuelto.stock - 1
                })
            });
        }
        
        if (nuevoResp.ok) {
            const nuevo = await nuevoResp.json();
            // Sumar 1 al stock del nuevo (revertir la entrega)
            await fetch(`/api/productos/${encodeURIComponent(cambio.articuloNuevo)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    precioPublico: nuevo.precioPublico,
                    costo: nuevo.costo,
                    stockFinal: nuevo.stock + 1
                })
            });
        }
        
        // 3. Eliminar el registro del cambio
        const deleteResp = await fetch(`/api/cambios/${id}`, {
            method: 'DELETE'
        });
        
        if (!deleteResp.ok) {
            throw new Error('Error al eliminar el registro');
        }
        
        showToast('‚úÖ Cambio eliminado y stock revertido', 'success');
        cargarCambios();
        
    } catch (error) {
        console.error('Error eliminando cambio:', error);
        showToast(`‚ùå ${error.message}`, 'error');
    }
}

async function crearCCdesdeCambio(cambioId, monto, fecha, artDevuelto, artNuevo) {
    const cliente = prompt(`Crear cuenta corriente con saldo a favor de ${formatMoney(monto)}\n\nIngres√° el nombre del cliente:`);
    
    if (!cliente || !cliente.trim()) {
        return; // Cancel√≥ o no ingres√≥ nombre
    }
    
    const nombreCliente = cliente.trim();
    
    try {
        // 1. Crear la cuenta (si ya existe, no pasa nada)
        await fetch('/api/cuentas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cliente: nombreCliente })
        });
        
        // 2. Registrar el pago (saldo a favor)
        const pagoResp = await fetch(`/api/cuentas/${encodeURIComponent(nombreCliente)}/movimiento`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tipo: 'pago',
                monto: monto,
                fecha: fecha,
                comentario: `Saldo a favor por cambio: ${artDevuelto} ‚Üí ${artNuevo}`
            })
        });
        
        if (!pagoResp.ok) {
            throw new Error('Error al registrar el saldo a favor');
        }
        
        showToast(`‚úÖ Cuenta corriente creada para ${nombreCliente} con saldo a favor de ${formatMoney(monto)}`, 'success');
        
    } catch (error) {
        console.error('Error creando CC:', error);
        showToast(`‚ùå ${error.message}`, 'error');
    }
}

    // ==================== FECHA POR DEFECTO ====================
    document.getElementById('fecha').valueAsDate = new Date();

    // ==================== FACTURA A/B TOGGLE ====================
    document.querySelectorAll('.factura-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.factura-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // ==================== MOSTRAR "OTRO TIPO DE PAGO" ====================
    document.getElementById('tipoPago').addEventListener('change', function() {
        const otroContainer = document.getElementById('otroTipoPagoContainer');
        if (this.value === 'otro') {
            otroContainer.style.display = 'block';
        } else {
            otroContainer.style.display = 'none';
        }
    });

    // ==================== 1. B√öSQUEDA DE PRECIOS (TAB BUSCAR PRECIOS) ====================
    document.getElementById('busquedaInput')?.addEventListener('keyup', async (e) => {
        const busqueda = e.target.value.trim();
        const resultado = document.getElementById('busquedaResultado');

        if (busqueda.length < 2) {
            resultado.innerHTML = busqueda.length === 1 ? '<div style="color:#999; padding:10px;">Escrib√≠ al menos 2 caracteres...</div>' : '';
            return;
        }

        try {
            const response = await fetch(`/api/productos/buscar?q=${encodeURIComponent(busqueda)}`);
            
            if (!response.ok) {
                resultado.innerHTML = `<div class="alert alert-danger show">‚ùå No se encontraron productos</div>`;
                return;
            }

            const data = await response.json();
            
            // Si hay m√∫ltiples resultados
            if (data.multiple) {
                resultado.innerHTML = `
                    <div style="margin-bottom: 10px; color: #666;">
                        Se encontraron ${data.productos.length} productos:
                    </div>
                    <div class="resultados-lista">
                        ${data.productos.map(p => `
                            <div class="resultado-item" onclick="mostrarProducto(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${p.codigo}</strong> - ${p.descripcion}
                                        <div style="font-size: 0.85em; color: #666;">${p.categoria || 'Sin categor√≠a'}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: bold; color: var(--primary);">${formatMoney(p.precioPublico || 0)}</div>
                                        <div style="font-size: 0.85em; color: ${(p.stock || 0) <= 0 ? '#d9534f' : '#5cb85c'}">Stock: ${p.stock || 0}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // Un solo resultado
                mostrarProductoDetalle(data, resultado);
            }
        } catch (error) {
            resultado.innerHTML = `<div class="alert alert-danger show">‚ö†Ô∏è Error: ${error.message}</div>`;
        }
    });

    function mostrarProducto(producto) {
        const resultado = document.getElementById('busquedaResultado');
        mostrarProductoDetalle(producto, resultado);
    }

    function mostrarProductoDetalle(producto, contenedor) {
        const precio = Number(producto.precioPublico) || 0;
        const costo  = Number(producto.costo) || 0;
        const stock  = Number(producto.stock);

        contenedor.innerHTML = `
            <div class="producto-resultado">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">${producto.descripcion}</h3>
                    <button onclick="document.getElementById('busquedaResultado').innerHTML=''; document.getElementById('busquedaInput').value=''; document.getElementById('busquedaInput').focus();" 
                            style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999;">√ó</button>
                </div>
                <div class="producto-grid">
                    <div class="producto-item">
                        <label>C√≥digo</label>
                        <div class="valor">${producto.codigo}</div>
                    </div>
                    <div class="producto-item">
                        <label>Categor√≠a</label>
                        <div class="valor">${producto.categoria || '-'}</div>
                    </div>
                    <div class="producto-item">
                        <label>Precio P√∫blico</label>
                        <div class="valor">${formatMoney(precio)}</div>
                    </div>
                    <div class="producto-item">
                        <label>Costo</label>
                        <div style="color: #999; font-size: 1.1em;">${formatMoney(costo)}</div>
                    </div>
                    <div class="producto-item">
                        <label>Stock</label>
                        <div class="valor" style="color: ${stock <= 0 ? '#d9534f' : stock <= 5 ? '#f0ad4e' : '#5cb85c'}">${stock}</div>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== 2. B√öSQUEDA R√ÅPIDA EN CAJAS DIARIAS ====================
    let productoActual = null;

    document.getElementById('busquedaRapida')?.addEventListener('keyup', async (e) => {
        const busqueda = e.target.value.trim();
        const resultado = document.getElementById('resultadoRapido');

        if (busqueda.length < 2) {
            resultado.innerHTML = busqueda.length === 1 ? '<div style="color:#999; padding:10px;">Escrib√≠ al menos 2 caracteres...</div>' : '';
            productoActual = null;
            return;
        }

        try {
            const response = await fetch(`/api/productos/buscar?q=${encodeURIComponent(busqueda)}`);
            
            if (!response.ok) {
                resultado.innerHTML = `<div class="alert alert-danger show">‚ùå No se encontraron productos</div>`;
                productoActual = null;
                return;
            }

            const data = await response.json();
            
            // Si hay m√∫ltiples resultados
            if (data.multiple) {
                resultado.innerHTML = `
                    <div class="resultados-lista" style="max-height: 250px;">
                        ${data.productos.map(p => `
                            <div class="resultado-item" onclick="seleccionarProductoVenta(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${p.codigo}</strong> - ${p.descripcion}
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="font-weight: bold; color: var(--primary);">${formatMoney(p.precioPublico || 0)}</span>
                                        <span style="font-size: 0.85em; color: ${(p.stock || 0) <= 0 ? '#d9534f' : '#5cb85c'}; margin-left: 10px;">Stock: ${p.stock || 0}</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                productoActual = null;
            } else {
                // Un solo resultado - mostrar detalle
                productoActual = data;
                mostrarProductoVenta(data, resultado);
            }
        } catch (error) {
            resultado.innerHTML = `<div class="alert alert-danger show">‚ö†Ô∏è Error: ${error.message}</div>`;
            productoActual = null;
        }
    });

    function seleccionarProductoVenta(producto) {
        productoActual = producto;
        mostrarProductoVenta(producto, document.getElementById('resultadoRapido'));
    }

    function mostrarProductoVenta(producto, contenedor) {
        const precio = Number(producto.precioPublico) || 0;
        const stock = Number(producto.stock);

        contenedor.innerHTML = `
            <div class="producto-resultado">
                <h3>${producto.descripcion}</h3>
                <div class="producto-grid">
                    <div class="producto-item">
                        <label>C√≥digo</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="valor">${producto.codigo}</div>
                            <button class="btn-agregar-venta" onclick="agregarProductoAVenta()" style="margin: 0; padding: 6px 12px; font-size: 13px;">‚úì Agregar</button>
                        </div>
                    </div>
                    <div class="producto-item">
                        <label>Categor√≠a</label>
                        <div class="valor">${producto.categoria || '-'}</div>
                    </div>
                    <div class="producto-item">
                        <label>Precio P√∫blico</label>
                        <div class="valor">${formatMoney(precio)}</div>
                    </div>
                    <div class="producto-item">
                        <label>Stock</label>
                        <div class="valor" style="color: ${stock <= 0 ? '#d9534f' : stock <= 5 ? '#f0ad4e' : '#5cb85c'}">${stock}</div>
                    </div>
                </div>
            </div>
        `;
    }

    // ==================== AGREGAR PRODUCTO DESDE B√öSQUEDA R√ÅPIDA ====================
    function agregarProductoAVenta() {
        if (!productoActual) return;
        
        document.getElementById('articulo').value = productoActual.codigo;
        document.getElementById('precio').value = productoActual.precioPublico || 0;
        document.getElementById('precio').dataset.original = productoActual.precioPublico || 0;
        document.getElementById('categoria').value = productoActual.categoria || '';
        document.getElementById('cantidad').value = 1;
        document.getElementById('descuento').value = 0;
        
        // Limpiar b√∫squeda r√°pida
        document.getElementById('busquedaRapida').value = '';
        document.getElementById('resultadoRapido').innerHTML = '';
        productoActual = null;

        // Actualizar total
  actualizarTotalACobrar();
        
        // Focus en cantidad
        document.getElementById('cantidad').focus();
    }

    // ==================== AUTOCOMPLETAR AL ESCRIBIR ART√çCULO ====================
    let timeoutArticulo;
    document.getElementById('articulo').addEventListener('input', function() {
        clearTimeout(timeoutArticulo);
        const codigo = this.value.trim();
        
        if (!codigo) {
            document.getElementById('precio').value = '';
            document.getElementById('precio').dataset.original = '';
            document.getElementById('categoria').value = '';
            return;
        }

        timeoutArticulo = setTimeout(async () => {
            try {
                const response = await fetch(`/api/productos/buscar?codigo=${codigo}`);
                if (response.ok) {
                    const producto = await response.json();
                    document.getElementById('precio').value = producto.precioPublico || 0;
                    document.getElementById('precio').dataset.original = producto.precioPublico || 0;
                    document.getElementById('categoria').value = producto.categoria || '';
                }
            } catch (error) {
                console.log('Producto no encontrado');
            }
        }, 500);
    });

    // ==================== RESETEAR PRECIO ORIGINAL SI SE EDITA MANUALMENTE ====================
document.getElementById('precio').addEventListener('input', function() {
    // Si el usuario edita el precio manualmente, ese se convierte en el "original"
    // (se resetea el dataset para que el descuento se aplique sobre lo que escribi√≥)
    const descuentoActual = parseInt(document.getElementById('descuento').value);
    
    // Solo resetear si no hay descuento aplicado
    if (descuentoActual === 0) {
        this.dataset.original = '';
    }
});


    // ==================== ACTUALIZAR PRECIO AL CAMBIAR DESCUENTO ====================
document.getElementById('descuento').addEventListener('change', function() {
  const precioField = document.getElementById('precio');
  const precioActual = parseFloat(precioField.value);
  
  if (!precioActual || precioActual === 0) return;

  // Guardar el precio base la primera vez
  if (!precioField.dataset.original) {
    precioField.dataset.original = precioActual;
  }
});

// CALCULAR Y MOSTRAR TOTAL A COBRAR
function actualizarTotalACobrar() {
  const precioField = document.getElementById('precio');
  const cantidadField = document.getElementById('cantidad');
  const descuentoField = document.getElementById('descuento');
  const totalDisplay = document.getElementById('totalACobrar');
  
  const precio = parseFloat(precioField.value) || 0;
  const cantidad = parseInt(cantidadField.value) || 0;
  const descuento = parseInt(descuentoField.value) || 0;
  
  if (precio === 0 || cantidad === 0) {
    totalDisplay.textContent = '$0.00';
    totalDisplay.style.background = 'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)';
    return;
  }
  
  const precioConDescuento = precio * (1 - (descuento / 100));
  const total = precioConDescuento * cantidad;
  
  totalDisplay.textContent = formatMoney(total);
  
  // Cambiar color seg√∫n descuento
  if (descuento > 0) {
    totalDisplay.style.background = 'linear-gradient(135deg, #28a745 0%, #20923c 100%)'; // Verde
  } else {
    totalDisplay.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)'; // Azul
  }
}

// Llamar la funci√≥n cuando cambie precio, cantidad o descuento
document.getElementById('precio').addEventListener('input', actualizarTotalACobrar);
document.getElementById('cantidad').addEventListener('input', actualizarTotalACobrar);
document.getElementById('descuento').addEventListener('change', actualizarTotalACobrar);


    // ==================== REGISTRAR VENTA ====================
    async function registrarVenta(event) {
    const btnRegistrar = event?.target;
    const textoOriginal = btnRegistrar?.innerHTML;
    
    if (btnRegistrar) {
        btnRegistrar.disabled = true;
        btnRegistrar.innerHTML = 'Registrando... <span class="loading-spinner"></span>';
    }
    
    try {
        const facturaBtn = document.querySelector('.factura-btn.active');
        let tipoPago = document.getElementById('tipoPago').value;
        
        if (tipoPago === 'otro') {
            tipoPago = document.getElementById('otroTipoPago').value.trim();
            if (!tipoPago) {
                alert('Por favor especifica el tipo de pago');
                return;
            }
        }

        const precioField = document.getElementById('precio');
        const cantidadField = document.getElementById('cantidad');
        
        let precioUnitario;
        if (precioField.dataset.original) {
            precioUnitario = parseFloat(precioField.dataset.original);
        } else {
            const precioActual = parseFloat(precioField.value);
            const cantidad = parseInt(cantidadField.value);
            precioUnitario = precioActual / cantidad;
        }
        
        const venta = {
            fecha: document.getElementById('fecha').value,
            articulo: document.getElementById('articulo').value.trim(),
            cantidad: parseInt(cantidadField.value),
            precio: precioUnitario,
            descuento: parseInt(document.getElementById('descuento').value) || 0,
            categoria: document.getElementById('categoria').value.trim(),
            factura: facturaBtn.dataset.value,
            tipoPago: tipoPago,
            comentarios: document.getElementById('comentarios').value.trim()
        };

        if (!venta.articulo || !venta.precio || !venta.cantidad) {
            alert('Por favor completa los campos obligatorios');
            return;
        }

        const response = await fetch('/api/ventas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(venta)
        });

        const data = await response.json();

        if (response.ok) {
            showToast('‚úÖ Venta registrada correctamente', 'success');
            
            document.getElementById('articulo').value = '';
            precioField.value = '';
            precioField.dataset.original = '';
            document.getElementById('categoria').value = '';
            cantidadField.value = 1;
            document.getElementById('descuento').value = 0;
            document.getElementById('comentarios').value = '';
            document.getElementById('otroTipoPago').value = '';
            document.getElementById('totalACobrar').textContent = '$0,00'; 
            document.getElementById('totalACobrar').style.background = 'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)';
            
            cargarVentasDelMes();
        } else {
            showToast(`‚ùå ${data.error || 'Error al registrar la venta'}`, 'error');
        }
    } catch (error) {
        console.error('Error en registrarVenta:', error);
        showToast(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    } finally {
        if (btnRegistrar) {
            btnRegistrar.disabled = false;
            btnRegistrar.innerHTML = textoOriginal || 'Registrar Venta';
        }
    }
}


    // ==================== BORRAR VENTAS ====================
async function borrarVenta(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta venta? Se devolver√° el stock.')) {
        return;
    }

    try {
        const response = await fetch(`/api/ventas/${id}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
            showToast(data.mensaje || '‚úÖ Venta eliminada correctamente', 'success');
            if (data.warning) {
                console.warn(data.warning);
            }
            cargarVentasDelMes();
        } else {
            showToast(`‚ùå ${data.error || 'Error al eliminar la venta'}`, 'error');
        }
    } catch (error) {
        console.error('Error en borrarVenta:', error);
        showToast(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}

// ==================== SELECTOR DE D√çAS DEL MES ====================
let fechaSeleccionada = new Date().toISOString().split('T')[0];
let ventasDelMes = [];

async function cargarVentasDelMes() {
    const hoy = new Date();
    const a√±o = hoy.getFullYear();
    const mes = hoy.getMonth();
    
    // Primer y √∫ltimo d√≠a del mes
    const primerDia = new Date(a√±o, mes, 1).toISOString().split('T')[0];
    const ultimoDia = new Date(a√±o, mes + 1, 0).toISOString().split('T')[0];
    
    try {
        const response = await fetch('/api/ventas');
        const todasVentas = await response.json();
        
        // Filtrar solo ventas del mes actual
        ventasDelMes = todasVentas.filter(v => v.fecha >= primerDia && v.fecha <= ultimoDia);
        
        generarDiasDelMes();
        cargarVentasDelDia(fechaSeleccionada);
        cargarCajaInicial(fechaSeleccionada);
    } catch (error) {
        console.error('Error cargando ventas del mes:', error);
    }
}

function generarDiasDelMes() {
    const hoy = new Date();
    const a√±o = hoy.getFullYear();
    const mes = hoy.getMonth();
    const nombreMes = hoy.toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
    
    // T√≠tulo del mes
    document.getElementById('mesActualTitulo').textContent = 
        nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);
    
    // Calcular d√≠as del mes
    const diasEnMes = new Date(a√±o, mes + 1, 0).getDate();
    const hoyStr = new Date().toISOString().split('T')[0];
    
    const diasHTML = [];
    
    for (let dia = 1; dia <= diasEnMes; dia++) {
        const fecha = new Date(a√±o, mes, dia);
        const fechaStr = fecha.toISOString().split('T')[0];
        const nombreDia = fecha.toLocaleDateString('es-AR', { weekday: 'short' });
        
        // Contar ventas de ese d√≠a
        const ventasDelDia = ventasDelMes.filter(v => v.fecha === fechaStr);
        const cantidadVentas = ventasDelDia.length;
        
        const esHoy = fechaStr === hoyStr;
        const esSeleccionado = fechaStr === fechaSeleccionada;
        
        diasHTML.push(`
            <button class="dia-btn ${esSeleccionado ? 'active' : ''} ${esHoy ? 'hoy' : ''}" 
                    onclick="seleccionarDia('${fechaStr}')">
                <span class="dia-numero">${dia}</span>
                <span class="dia-nombre">${nombreDia}</span>
                ${cantidadVentas > 0 ? `<span class="dia-ventas">üìä ${cantidadVentas}</span>` : ''}
            </button>
        `);
    }
    
    document.getElementById('diasDelMes').innerHTML = diasHTML.join('');
}

function seleccionarDia(fecha) {
    fechaSeleccionada = fecha;
    generarDiasDelMes(); // Re-renderizar para actualizar el activo
    cargarVentasDelDia(fecha);
    cargarCajaInicial(fecha);
}

function cargarVentasDelDia(fecha) {
    const ventasDelDia = ventasDelMes.filter(v => v.fecha === fecha);
    
    // Actualizar t√≠tulo
    const fechaObj = new Date(fecha + 'T00:00:00');
    const nombreDia = fechaObj.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    document.getElementById('ventasDiaTitulo').textContent = 
        'Ventas del ' + nombreDia.charAt(0).toUpperCase() + nombreDia.slice(1);
    
    const lista = document.getElementById('listaVentas');
    
    if (ventasDelDia.length === 0) {
        lista.innerHTML = '<p style="color: #999;">No hay ventas registradas para este d√≠a</p>';
        return;
    }

    let totalDia = 0;
    let totalFacturaA = 0;
    let totalFacturaB = 0;
    let cantFacturaA = 0;
    let cantFacturaB = 0;

    lista.innerHTML = ventasDelDia.map(v => {
  const precioUnitario = v.precio; // Precio SIN descuento
  const precioFinal = v.precio * (1 - (v.descuento || 0)/100);
  const total = precioFinal * v.cantidad;
  totalDia += total;
  
  // Sumar por tipo de factura
  const tipoFactura = (v.factura || '').toUpperCase().trim();
  if (tipoFactura === 'A') {
      totalFacturaA += total;
      cantFacturaA++;
  } else if (tipoFactura === 'B') {
      totalFacturaB += total;
      cantFacturaB++;
  }

  return `
    <div class="venta-item">
      <button class="btn-eliminar-venta" onclick="borrarVenta(${v.id})" title="Eliminar venta">‚ùå</button>
      <div class="venta-detail"><strong>Fecha:</strong> ${v.fecha}</div>
      <div class="venta-detail"><strong>Art√≠culo:</strong> ${v.articulo}</div>
      <div class="venta-detail"><strong>Cantidad:</strong> ${v.cantidad}</div>
      <div class="venta-detail"><strong>Precio Unit.:</strong> ${formatMoney(precioUnitario)}</div>
      ${v.descuento > 0 ? `<div class="venta-detail"><strong>Descuento:</strong> ${v.descuento}%</div>` : ''}
      <div class="venta-detail"><strong>Total:</strong> ${formatMoney(total)}</div>
      <div class="venta-detail"><strong>Categor√≠a:</strong> ${v.categoria}</div>
      <div class="venta-detail"><strong>Factura:</strong> ${v.factura}</div>
      <div class="venta-detail"><strong>Pago:</strong> ${v.tipoPago}</div>
      ${v.comentarios ? `<div class="venta-comentario"><strong> Comentario:</strong> ${v.comentarios}</div>` : ''}
    </div>
  `;
}).join('');


    // Agregar total del d√≠a con desglose A/B
    lista.innerHTML += `
        <div style="background: linear-gradient(135deg, #28a745 0%, #20923c 100%); color: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="font-size: 1em; opacity: 0.9; margin-bottom: 5px;">Factura A</div>
                    <div style="font-size: 1.5em; font-weight: 700;">${formatMoney(totalFacturaA)}</div>
                    <div style="font-size: 0.85em; opacity: 0.8;">${cantFacturaA} venta${cantFacturaA !== 1 ? 's' : ''}</div>
                </div>
                <div>
                    <div style="font-size: 1em; opacity: 0.9; margin-bottom: 5px;">Factura B</div>
                    <div style="font-size: 1.5em; font-weight: 700;">${formatMoney(totalFacturaB)}</div>
                    <div style="font-size: 0.85em; opacity: 0.8;">${cantFacturaB} venta${cantFacturaB !== 1 ? 's' : ''}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 1em; opacity: 0.9; margin-bottom: 5px;">Total del D√≠a</div>
                    <div style="font-size: 2em; font-weight: 700;">${formatMoney(totalDia)}</div>
                    <div style="font-size: 0.85em; opacity: 0.8;">${ventasDelDia.length} venta${ventasDelDia.length !== 1 ? 's' : ''}</div>
                </div>
            </div>
        </div>
    `;
}

// ==================== CAJA INICIAL DEL D√çA ====================
let cajasIniciales = {}; // Cache local

async function cargarCajaInicial(fecha) {
    const input = document.getElementById('cajaInicial');
    if (!input) return;
    
    try {
        const response = await fetch(`/api/caja-inicial/${fecha}`);
        if (response.ok) {
            const data = await response.json();
            input.value = data.monto > 0 ? formatMonedaInput(data.monto) : '';
        } else {
            input.value = '';
        }
    } catch (e) {
        console.error('Error cargando caja inicial:', e);
        input.value = '';
    }
}

async function guardarCajaInicial() {
    if (!fechaSeleccionada) return;
    
    const input = document.getElementById('cajaInicial');
    // Quitar $ y puntos de miles, quedarnos solo con d√≠gitos
    const valorStr = input.value.replace(/[^\d]/g, '');
    const monto = parseInt(valorStr) || 0;
    
    // No guardar si est√° vac√≠o y no mostrar toast
    if (monto === 0 && input.value === '') return;
    
    console.log('Guardando caja inicial:', fechaSeleccionada, monto);
    
    try {
        const response = await fetch('/api/caja-inicial', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fecha: fechaSeleccionada, monto })
        });
        
        if (response.ok && monto > 0) {
            showToast('Caja inicial guardada', 'success');
        } else if (!response.ok) {
            showToast('Error al guardar caja', 'error');
        }
    } catch (e) {
        console.error('Error guardando caja inicial:', e);
        showToast('Error al guardar caja', 'error');
    }
}

function formatearInputMoneda(input) {
    let valor = input.value.replace(/[^\d]/g, '');
    if (valor) {
        valor = parseInt(valor).toLocaleString('es-AR');
        input.value = '$' + valor;
    }
}

function formatMonedaInput(monto) {
    return '$' + Math.round(monto).toLocaleString('es-AR');
}

    // ==================== CARGAR VENTAS ====================
    async function cargarVentas() {
    try {
        const response = await fetch('/api/ventas');
        const ventas = await response.json();
        
        const lista = document.getElementById('listaVentas');
        if (ventas.length === 0) {
            lista.innerHTML = '<p style="color: #999;">No hay ventas registradas</p>';
            return;
        }

        let totalDia = 0;

        lista.innerHTML = ventas.map(v => {
            const precioFinal = v.precio * (1 - v.descuento / 100);
            const total = precioFinal * v.cantidad;
            totalDia += total;
            
            return `
                <div class="venta-item">
                    <button class="btn-eliminar-venta" onclick="borrarVenta(${v.id})" title="Eliminar venta">‚úï</button>
                    <div class="venta-detail"><strong>Fecha</strong> ${v.fecha}</div>
                    <div class="venta-detail"><strong>Art√≠culo</strong> ${v.articulo}</div>
                    <div class="venta-detail"><strong>Cantidad</strong> ${v.cantidad}</div>
                    <div class="venta-detail"><strong>Precio Unit.</strong> ${formatMoney(precioFinal)} ${v.descuento > 0 ? `(-${v.descuento}%)` : ''}</div>
                    <div class="venta-detail"><strong>Total</strong> ${formatMoney(total)}</div>
                    <div class="venta-detail"><strong>Categor√≠a</strong> ${v.categoria}</div>
                    <div class="venta-detail"><strong>Factura</strong> ${v.factura}</div>
                    <div class="venta-detail"><strong>Pago</strong> ${v.tipoPago}</div>
                    ${v.comentarios ? `
                        <div class="venta-comentario">
                            <strong>üí¨ Comentario:</strong> ${v.comentarios}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');

        // Agregar total del d√≠a
        lista.innerHTML += `
            <div style="background: linear-gradient(135deg, #28a745 0%, #20923c 100%); color: white; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: right;">
                <div style="font-size: 1.1em; margin-bottom: 8px;">Total del D√≠a</div>
                <div style="font-size: 2.2em; font-weight: 700;">${formatMoney(totalDia)}</div>
                <div style="font-size: 0.95em; opacity: 0.9; margin-top: 5px;">${ventas.length} venta${ventas.length !== 1 ? 's' : ''}</div>
            </div>
        `;
    } catch (error) {
        console.error('Error cargando ventas:', error);
    }
}

    // ==================== 3. UPLOAD CSV ====================
    async function uploadCSV() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/stock/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            let mensaje = `‚úÖ ${result.procesados} productos actualizados`;
            if (result.errores && result.errores.length > 0) {
                mensaje += ` (${result.errores.length} errores)`;
            }

            showAlert('alertaStock', mensaje, 'success');

            if (result.errores && result.errores.length > 0) {
                const errorHTML = result.errores.map(e => `${e.codigo}: ${e.error}`).join('<br>');
                document.getElementById('resultadoStock').innerHTML = `<div class="alert alert-warning show"><strong>Errores:</strong><br>${errorHTML}</div>`;
            }

            document.getElementById('csvFile').value = '';
        } catch (error) {
            showAlert('alertaStock', `‚ùå ${error.message}`, 'danger');
        }
    }

    // ==================== IMPORTAR PRODUCTOS COMPLETOS ====================
    async function importarProductosCSV() {
        const file = document.getElementById('csvProductos').files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/productos/importar', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.ok) {
                showAlert('alertaProductos', `‚úÖ ${result.importados} productos importados` + (result.omitidos > 0 ? ` (${result.omitidos} omitidos)` : ''), 'success');
                cargarStockCompleto(); // Recargar la tabla
            } else {
                showAlert('alertaProductos', `‚ùå ${result.error}`, 'danger');
            }

            document.getElementById('csvProductos').value = '';
        } catch (error) {
            showAlert('alertaProductos', `‚ùå ${error.message}`, 'danger');
        }
    }

    // ==================== STOCK: BUSCAR Y EDITAR PRODUCTO ====================
let productoStockActual = null;

document.getElementById('stockBusquedaCodigo')?.addEventListener('keyup', async (e) => {
    const busqueda = e.target.value.trim();
    const resultado = document.getElementById('stockBusquedaResultado');
    const editor = document.getElementById('stockEditor');

    if (busqueda.length < 2) {
        resultado.style.display = busqueda.length === 1 ? 'block' : 'none';
        resultado.innerHTML = busqueda.length === 1 ? '<span style="color:#999;">Escrib√≠ al menos 2 caracteres...</span>' : '';
        editor.style.display = 'none';
        productoStockActual = null;
        return;
    }

    try {
        const response = await fetch(`/api/productos/buscar?q=${encodeURIComponent(busqueda)}`);
        if (!response.ok) {
            resultado.style.display = 'block';
            resultado.innerHTML = '‚ùå No se encontraron productos';
            editor.style.display = 'none';
            productoStockActual = null;
            return;
        }

        const data = await response.json();
        
        // Si hay m√∫ltiples resultados
        if (data.multiple) {
            resultado.style.display = 'block';
            resultado.innerHTML = `
                <div class="resultados-lista" style="max-height: 250px;">
                    ${data.productos.map(p => `
                        <div class="resultado-item" onclick="seleccionarProductoStock(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${p.codigo}</strong> - ${p.descripcion}
                                </div>
                                <div style="text-align: right;">
                                    <span style="font-weight: bold; color: var(--primary);">${formatMoney(p.precioPublico || 0)}</span>
                                    <span style="font-size: 0.85em; color: ${(p.stock || 0) <= 0 ? '#d9534f' : '#5cb85c'}; margin-left: 10px;">Stock: ${p.stock || 0}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            editor.style.display = 'none';
            productoStockActual = null;
        } else {
            // Un solo resultado - mostrar editor
            mostrarEditorStock(data);
        }
    } catch (error) {
        resultado.style.display = 'block';
        resultado.innerHTML = '‚ö†Ô∏è Error: ' + error.message;
        editor.style.display = 'none';
        productoStockActual = null;
    }
});

function seleccionarProductoStock(producto) {
    mostrarEditorStock(producto);
}

function mostrarEditorStock(producto) {
    const resultado = document.getElementById('stockBusquedaResultado');
    const editor = document.getElementById('stockEditor');
    
    productoStockActual = producto;
    resultado.style.display = 'none';
    resultado.innerHTML = '';

    // Llenar editor
    document.getElementById('stockProductoTitulo').textContent = producto.descripcion || '';
    document.getElementById('stockCodigo').textContent = producto.codigo || '';
    document.getElementById('stockCategoria').textContent = producto.categoria || '';
    document.getElementById('stockPrecioPublico').value = producto.precioPublico || 0;
    document.getElementById('stockCosto').value = producto.costo || 0;
    document.getElementById('stockActual').textContent = producto.stock ?? 0;
    document.getElementById('stockDelta').value = 0;
    document.getElementById('stockFinal').textContent = producto.stock ?? 0;

    document.getElementById('stockEditorMensaje').style.display = 'none';
    editor.style.display = 'block';
}

// Recalcular stock final cuando cambia delta
document.getElementById('stockDelta')?.addEventListener('input', () => {
    if (!productoStockActual) return;
    const actual = Number(productoStockActual.stock) || 0;
    const delta = parseInt(document.getElementById('stockDelta').value) || 0;
    const final = actual + delta;
    document.getElementById('stockFinal').textContent = final;
});

// ==================== STOCK: GUARDAR CAMBIOS ====================
async function guardarStockYPrecios(event) {
    const btnGuardar = event?.target;
    const textoOriginal = btnGuardar?.innerHTML;
    
    if (btnGuardar) {
        btnGuardar.disabled = true;
        btnGuardar.innerHTML = 'Guardando... <span class="loading-spinner"></span>';
    }
    
    try {
        if (!productoStockActual) return;

        const mensaje = document.getElementById('stockEditorMensaje');
        mensaje.style.display = 'none';
        mensaje.style.color = '#a94442';
        mensaje.textContent = '';

        const codigo = productoStockActual.codigo;
        const precioPublico = parseFloat(document.getElementById('stockPrecioPublico').value) || 0;
        const costo = parseFloat(document.getElementById('stockCosto').value) || 0;
        const stockActual = Number(productoStockActual.stock) || 0;
        const delta = parseInt(document.getElementById('stockDelta').value) || 0;
        const stockFinal = stockActual + delta;

        if (stockFinal < 0) {
            mensaje.style.display = 'block';
            mensaje.textContent = '‚ö†Ô∏è El stock final no puede ser negativo';
            return;
        }

        const response = await fetch(`/api/productos/${encodeURIComponent(codigo)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ precioPublico, costo, stockFinal })
        });

        if (!response.ok) {
            let errorText = 'desconocido';
            try {
                const error = await response.json();
                errorText = error.error || errorText;
            } catch (_) {}
            mensaje.style.display = 'none';
            showToast('Error al guardar: ' + errorText, 'error');
            return;
        }

        productoStockActual.precioPublico = precioPublico;
        productoStockActual.costo = costo;
        productoStockActual.stock = stockFinal;

        document.getElementById('stockActual').textContent = stockFinal;
        document.getElementById('stockDelta').value = 0;
        document.getElementById('stockFinal').textContent = stockFinal;

        mensaje.style.display = 'none';
        showToast('Cambios guardados correctamente', 'success');

    } catch (error) {
        const mensaje = document.getElementById('stockEditorMensaje');
        mensaje.style.display = 'none';
        showToast('Error: ' + error.message, 'error');
    } finally {
        if (btnGuardar) {
            btnGuardar.disabled = false;
            btnGuardar.innerHTML = textoOriginal || 'Guardar Cambios';
        }
    }
}

// ==================== STOCK: LISTADO Y RESUMEN ====================
let productosCache = [];

async function cargarStockCompleto() {
    try {
        const resp = await fetch('/api/productos');
        const productos = await resp.json();
        productosCache = productos || [];

        renderStockResumen();
        renderStockTabla();
        llenarFiltroCategorias();
    } catch (error) {
        console.error('Error cargando productos:', error);
    }
}

function renderStockResumen() {
    const totalEl = document.getElementById('stockResumenTotal');
    const cont = document.getElementById('stockResumen');
    if (!totalEl || !cont) return;

    let totalPrendas = 0;
    const porCategoria = {};

    productosCache.forEach(p => {
        const stock = Number(p.stock) || 0;
        totalPrendas += stock;
        const cat = p.categoria || 'Sin categor√≠a';
        porCategoria[cat] = (porCategoria[cat] || 0) + stock;
    });

    // Box superior derecho: PRENDAS TOTALES: X (Y art√≠culos)
    totalEl.innerHTML = `
        <span class="stock-resumen-total-label">PRENDAS TOTALES -</span>
        <span class="stock-resumen-total-value">${totalPrendas}</span>
        <span style="font-size:0.78em; opacity:0.9;">(${productosCache.length} art√≠culos)</span>
    `;

    // Tarjetas clickeables por categor√≠a
    let html = '';
    Object.entries(porCategoria).forEach(([cat, stock]) => {
        const safeCat = cat.replace(/"/g, '&quot;');
        html += `
            <div class="stock-resumen-item" onclick="filtrarPorCategoria('${safeCat}')">
                <h4>${cat}</h4>
                <div class="valor">${stock}</div>
            </div>
        `;
    });

    cont.innerHTML = html;
}


function filtrarPorCategoria(cat) {
    const select = document.getElementById('filtroCategoria');
    if (!select) return;
    select.value = cat === 'Sin categor√≠a' ? '' : cat;
    renderStockTabla();
    // scroll suave hasta la tabla
    document.querySelector('.stock-tabla-wrapper')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}


function llenarFiltroCategorias() {
    const select = document.getElementById('filtroCategoria');
    if (!select) return;

    const categorias = new Set();
    productosCache.forEach(p => {
        if (p.categoria) categorias.add(p.categoria);
    });

    const valorActual = select.value || '';
    select.innerHTML = '<option value="">Todas las categor√≠as</option>' +
        Array.from(categorias).sort().map(c => `<option value="${c}">${c}</option>`).join('');
    select.value = valorActual;
}

function renderStockTabla() {
    const tbody = document.getElementById('stockTablaBody');
    if (!tbody) return;

    const catFiltro = document.getElementById('filtroCategoria')?.value || '';
    const texto = (document.getElementById('filtroTexto')?.value || '').toLowerCase().trim();

    const filtrados = productosCache.filter(p => {
        if (catFiltro && p.categoria !== catFiltro) return false;
        if (!texto) return true;
        const hay = (p.descripcion || '').toLowerCase().includes(texto) ||
                    (p.codigo || '').toLowerCase().includes(texto);
        return hay;
    });

    if (filtrados.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#9ca3af; padding:12px;">Sin art√≠culos que coincidan con el filtro</td></tr>`;
        return;
    }

    tbody.innerHTML = filtrados.map(p => `
        <tr>
            <td>${p.codigo}</td>
            <td>${p.descripcion || ''}</td>
            <td>${p.categoria || ''}</td>
            <td class="num">${formatMoney(p.precioPublico || 0)}</td>
            <td class="num">${formatMoney(p.costo || 0)}</td>
            <td class="num">${p.stock ?? 0}</td>
        </tr>
    `).join('');
}

// Filtros en tiempo real
document.getElementById('filtroCategoria')?.addEventListener('change', renderStockTabla);
document.getElementById('filtroTexto')?.addEventListener('input', renderStockTabla);


    // ==================== 4. CUENTAS CORRIENTES ====================
async function crearCuenta() {
    const cliente = document.getElementById('cuentasCliente').value.trim();

    if (!cliente) {
        showAlert('alertaCuentas', '‚ö†Ô∏è Ingresa el nombre del cliente', 'warning');
        return;
    }

    try {
        const response = await fetch('/api/cuentas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cliente })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Error al crear cuenta');
        }

        showAlert('alertaCuentas', '‚úÖ Cuenta creada correctamente', 'success');
        document.getElementById('cuentasCliente').value = '';
        cargarCuentas();
    } catch (error) {
        console.error('Error en crearCuenta:', error);
        showAlert('alertaCuentas', `‚ùå ${error.message}`, 'danger');
    }
}

// Mini tabs de cuentas
function switchCuentasTab(tab, event) {
    document.querySelectorAll('.mini-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.cuentas-tab-content').forEach(tc => tc.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab === 'activas' ? 'cuentasActivas' : 'cuentasSaldadas').classList.add('active');
}

// Toggle para mostrar/ocultar historial
function toggleHistorial(clienteId) {
    const content = document.getElementById(`historial-${clienteId}`);
    const button = event.target.closest('.historial-toggle');
    
    content.classList.toggle('open');
    button.classList.toggle('open');
}


async function agregarMovimiento(cliente, tipo) {
    const clienteId = cliente.replace(/\s/g, '-');
    const inputMontoId = `${tipo}-${clienteId}`;
    const inputFechaId = `fecha-${tipo}-${clienteId}`;
    const inputComentarioId = `comentario-${tipo}-${clienteId}`;
    
    const monto = parseFloat(document.getElementById(inputMontoId).value);
    const fecha = document.getElementById(inputFechaId).value;
    const comentario = document.getElementById(inputComentarioId).value.trim();

    if (!monto || monto <= 0) {
        showToast('‚ö†Ô∏è Ingresa un monto v√°lido', 'error');
        return;
    }

    if (!fecha) {
        showToast('‚ö†Ô∏è Selecciona una fecha', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/cuentas/${encodeURIComponent(cliente)}/movimiento`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tipo, monto, fecha, comentario })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Error al agregar movimiento');
        }

        showToast(`‚úÖ ${tipo === 'deuda' ? 'Deuda' : 'Pago'} registrado correctamente`, 'success');
        document.getElementById(inputMontoId).value = '';
        document.getElementById(inputComentarioId).value = '';
        cargarCuentas();
    } catch (error) {
        console.error('Error en agregarMovimiento:', error);
        showToast(`‚ùå ${error.message}`, 'error');
    }
}

async function cargarCuentas() {
    try {
        const response = await fetch('/api/cuentas');
        const cuentas = await response.json();

        const gridActivas = document.getElementById('cuentasGridActivas');
        const gridSaldadas = document.getElementById('cuentasGridSaldadas');

        // LOADING INDICATOR
    if (gridActivas) {
        gridActivas.innerHTML = '<div style="text-align:center; padding:30px; color:#666;"><span class="loading-spinner"></span> Cargando cuentas...</div>';
    }
    if (gridSaldadas) {
        gridSaldadas.innerHTML = '';
    }

        if (!cuentas || cuentas.length === 0) {
            gridActivas.innerHTML = `<div class="empty-state"><p>üì≠ Sin cuentas registradas</p></div>`;
            gridSaldadas.innerHTML = '';
            document.getElementById('totalesCuentas').innerHTML = '';
            return;
        }

        const hoy = new Date().toISOString().split('T')[0];
        let totalDeuda = 0;
        let totalPagos = 0;

        // Para cada cuenta, traemos sus movimientos para saber si tiene historial
        const cuentasConMovimientos = await Promise.all(
            cuentas.map(async (c) => {
                const movResponse = await fetch(`/api/cuentas/${encodeURIComponent(c.cliente)}/movimientos`);
                const movimientos = await movResponse.json();
                return { ...c, movimientos };
            })
        );

        // Separar activas y saldadas seg√∫n saldo + movimientos
        const activas = [];
        const saldadas = [];

        cuentasConMovimientos.forEach(c => {
            const saldo = c.deuda - c.pagos;
            const tieneMovimientos = c.movimientos && c.movimientos.length > 0;

            if (saldo !== 0) {
                activas.push(c);
            } else if (tieneMovimientos) {
                saldadas.push(c);
            } else {
                // saldo 0 y sin movimientos ‚Üí reci√©n creada ‚Üí activa
                activas.push(c);
            }
        });

        // Funci√≥n para generar el HTML de una cuenta (usamos los movimientos ya cargados)
        const generarCuentaHTML = (c) => {
            const saldo = c.deuda - c.pagos;
            totalDeuda += c.deuda;
            totalPagos += c.pagos;

            const clienteId = c.cliente.replace(/\s/g, '-');
            const movimientos = c.movimientos || [];

            const historialHTML = movimientos.length > 0 ? `
                <div class="cuenta-historial">
                    <button class="historial-toggle" onclick="toggleHistorial('${clienteId}')">
                        <span>üìã Historial de Movimientos (${movimientos.length})</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="historial-content" id="historial-${clienteId}">
                        ${movimientos.map(m => `
                            <div class="movimiento-item ${m.tipo}">
                                <div class="movimiento-header">
                                    <span class="movimiento-tipo ${m.tipo}">
                                        ${m.tipo === 'deuda' ? 'üìà Deuda' : 'üí∞ Pago'}
                                    </span>
                                    <span class="movimiento-monto">${formatMoney(m.monto)}</span>
                                </div>
                                <div class="movimiento-fecha">üìÖ ${m.fecha}</div>
                                ${m.comentario ? `<div class="movimiento-comentario">üí¨ ${m.comentario}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            return `
                <div class="cuenta-box">
                    <button class="btn-eliminar-cuenta" onclick="eliminarCuenta('${c.cliente}')" title="Eliminar cuenta">‚úï</button>
                    <h3>üë§ ${c.cliente}</h3>
                    
                    <div class="cuenta-saldo">
                        <div class="cuenta-valor">
                            <label>Deuda</label>
                            <div class="monto" style="color: #d9534f;">${formatMoney(c.deuda)}</div>
                        </div>
                        <div class="cuenta-valor">
                            <label>Pagos</label>
                            <div class="monto" style="color: #5cb85c;">${formatMoney(c.pagos)}</div>
                        </div>
                        <div class="cuenta-valor">
                            <label>Saldo</label>
                            <div class="monto" style="color: ${saldo > 0 ? '#d9534f' : saldo < 0 ? '#5cb85c' : '#333'};">${formatMoney(saldo)}</div>
                        </div>
                    </div>

                    <div class="cuenta-acciones">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <input type="date" id="fecha-deuda-${clienteId}" value="${hoy}" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            <input type="text" id="comentario-deuda-${clienteId}" placeholder="Comentario (opcional)" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            <div class="cuenta-input-group">
                                <input type="number" id="deuda-${clienteId}" placeholder="$ Deuda" min="0" step="0.01">
                                <button class="btn-cuenta deuda" onclick="agregarMovimiento('${c.cliente}', 'deuda')">+ Deuda</button>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <input type="date" id="fecha-pago-${clienteId}" value="${hoy}" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            <input type="text" id="comentario-pago-${clienteId}" placeholder="Comentario (opcional)" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                            <div class="cuenta-input-group">
                                <input type="number" id="pago-${clienteId}" placeholder="$ Pago" min="0" step="0.01">
                                <button class="btn-cuenta pago" onclick="agregarMovimiento('${c.cliente}', 'pago')">+ Pago</button>
                            </div>
                        </div>
                    </div>

                    ${historialHTML}
                </div>
            `;
        };

        // Renderizar activas
        if (activas.length > 0) {
            gridActivas.innerHTML = `<div class="cuentas-grid">` + activas.map(generarCuentaHTML).join('') + `</div>`;
        } else {
            gridActivas.innerHTML = `<div class="empty-state"><p>‚úÖ No hay cuentas activas</p></div>`;
        }

        // Renderizar saldadas
        if (saldadas.length > 0) {
            gridSaldadas.innerHTML = `<div class="cuentas-grid">` + saldadas.map(generarCuentaHTML).join('') + `</div>`;
        } else {
            gridSaldadas.innerHTML = `<div class="empty-state"><p>üì≠ No hay cuentas saldadas</p></div>`;
        }

        // Totales generales (se siguen calculando con todas)
        const saldoTotal = totalDeuda - totalPagos;
        document.getElementById('totalesCuentas').innerHTML = `
            <div style="background: linear-gradient(135deg, ${saldoTotal > 0 ? '#d9534f' : '#5cb85c'} 0%, ${saldoTotal > 0 ? '#c9302c' : '#4cae4c'} 100%); color: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                    <div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Total Deuda</div>
                        <div style="font-size: 1.8em; font-weight: 700;">${formatMoney(totalDeuda)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Total Pagos</div>
                        <div style="font-size: 1.8em; font-weight: 700;">${formatMoney(totalPagos)}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">Saldo Total</div>
                        <div style="font-size: 2.2em; font-weight: 700;">${formatMoney(saldoTotal)}</div>
                    </div>
                </div>
                <div style="text-align: center; font-size: 0.9em; opacity: 0.9; margin-top: 15px;">
                    ${activas.length} activa${activas.length !== 1 ? 's' : ''} ¬∑ ${saldadas.length} saldada${saldadas.length !== 1 ? 's' : ''}
                </div>
            </div>
        `;
    } catch (error) {
        document.getElementById('cuentasGridActivas').innerHTML = `<div class="alert alert-danger show">Error: ${error.message}</div>`;
    }
}


// ==================== ELIMINAR CUENTA ====================
async function eliminarCuenta(cliente) {
    if (!confirm(`¬øEst√°s seguro de eliminar la cuenta de "${cliente}"?\n\nSe borrar√°n todos los movimientos y no se puede deshacer.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/cuentas/${encodeURIComponent(cliente)}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
            showToast('‚úÖ Cuenta eliminada correctamente', 'success');
            cargarCuentas();
        } else {
            showToast(`‚ùå ${data.error || 'Error al eliminar cuenta'}`, 'error');
        }
    } catch (error) {
        console.error('Error en eliminarCuenta:', error);
        showToast(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
    }
}


    // ==================== INICIALIZACI√ìN ====================
    // ==================== INICIALIZACI√ìN ====================
window.addEventListener('load', () => {
    cargarVentasDelMes();
    cargarStockCompleto();
    initHistorico();
});


    // ==================== DRAG & DROP PARA CSV ====================
    const uploadArea = document.querySelector('.upload-area');
    if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.style.background = '#e8f4f8';
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.style.background = '';
            });
        });

        uploadArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('csvFile').files = files;
            uploadCSV();
        });
    }

    // ==================== FUNCION PARA EL TOAST ====================
    function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.className = 'toast ' + (type === 'success' ? 'toast-success' : 'toast-error');
    toast.textContent = message;
    toast.classList.add('show');

    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// ==================== HIST√ìRICO DE VENTAS ====================
let historicoVentas = [];
let ventasFiltradas = [];

function initHistorico() {
    const anioSelect = document.getElementById('historicoAnio');
    if (!anioSelect) return;

    const hoy = new Date();
    const anioActual = hoy.getFullYear();

    // Rango de a√±os
    for (let y = anioActual; y >= 2023; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        anioSelect.appendChild(opt);
    }
    anioSelect.value = anioActual;

    // Meses
    const mesesCont = document.getElementById('historicoMeses');
    const nombresMes = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const mesActual = hoy.getMonth() + 1;

    for (let m = 1; m <= 12; m++) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'mes-pill' + (m === mesActual ? ' selected' : '');
        btn.dataset.mes = m;
        btn.textContent = nombresMes[m - 1];
        btn.addEventListener('click', () => toggleMesSeleccionado(m));
        mesesCont.appendChild(btn);
    }

    anioSelect.addEventListener('change', cargarHistorico);
    cargarHistorico();
}

function getMesesSeleccionados() {
    return Array.from(document.querySelectorAll('.mes-pill.selected'))
        .map(el => parseInt(el.dataset.mes));
}

function toggleMesSeleccionado(mes) {
    const el = document.querySelector(`.mes-pill[data-mes="${mes}"]`);
    if (!el) return;
    el.classList.toggle('selected');

    const seleccionados = getMesesSeleccionados();
    if (seleccionados.length === 0) {
        el.classList.add('selected');
        return;
    }
    cargarHistorico();
}

async function cargarHistorico() {
    const anio = document.getElementById('historicoAnio').value;
    const meses = getMesesSeleccionados();
    if (!anio || meses.length === 0) return;

    try {
        const resp = await fetch(`/api/ventas/historico?anio=${anio}&meses=${meses.join(',')}`);
        historicoVentas = await resp.json();
        ventasFiltradas = [];
        renderHistorico(anio, meses);
        
        // Abrir gr√°ficos autom√°ticamente
        if (historicoVentas.length > 0) {
            const seccion = document.getElementById('seccionGraficos');
            if (seccion && seccion.style.display === 'none') {
                toggleSeccionGraficos();
            }
        }
    } catch (err) {
        console.error('Error hist√≥rico:', err);
    }
}


function renderHistorico(anio, meses) {
    const periodoLabel = document.getElementById('histPeriodoLabel');
    const nombresMesLargos = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    if (meses.length === 1) {
        periodoLabel.textContent = `${nombresMesLargos[meses[0]-1]} ${anio}`;
    } else {
        const primero = nombresMesLargos[meses[0]-1];
        const ultimo = nombresMesLargos[meses[meses.length-1]-1];
        periodoLabel.textContent = `${primero} ‚Äì ${ultimo} ${anio}`;
    }

    // M√©tricas
    let totalVentas = 0;
    let totalPrendas = 0;
    let facturaACant = 0;
    let facturaAMonto = 0;
    let facturaBCant = 0;
    let facturaBMonto = 0;

    historicoVentas.forEach(v => {
        const precioFinal = v.precio * (1 - (v.descuento || 0)/100);
        const total = precioFinal * v.cantidad;
        totalVentas += total;
        totalPrendas += v.cantidad;
        
        // Contar facturas y sumar montos
        const tipoFactura = (v.factura || '').toUpperCase().trim();
        if (tipoFactura === 'A') {
            facturaACant++;
            facturaAMonto += total;
        } else if (tipoFactura === 'B') {
            facturaBCant++;
            facturaBMonto += total;
        }
    });

    const totalTickets = historicoVentas.length;
    const ticketPromedio = totalTickets ? totalVentas / totalTickets : 0;

    document.getElementById('histTotalVentas').textContent = formatMoney(totalVentas);
    document.getElementById('histTotalTickets').textContent = `${totalTickets} tickets`;
    document.getElementById('histPrendasVendidas').textContent = totalPrendas;
    document.getElementById('histTicketPromedio').textContent = formatMoney(ticketPromedio);
    
    // Facturaci√≥n A y B separadas
    document.getElementById('histFacturaAMonto').textContent = formatMoney(facturaAMonto);
    document.getElementById('histFacturaACant').textContent = `${facturaACant} tickets`;
    document.getElementById('histFacturaBMonto').textContent = formatMoney(facturaBMonto);
    document.getElementById('histFacturaBCant').textContent = `${facturaBCant} tickets`;

    // Tabla de ventas
    const tbody = document.getElementById('histVentasBody');
    if (!historicoVentas.length) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:#9ca3af; padding:10px;">Sin ventas en este per√≠odo</td></tr>`;
        return;
    }

    tbody.innerHTML = historicoVentas.map(v => {
    const precioUnitario = v.precio; // Precio base SIN descuento
    const precioConDescuento = v.precio * (1 - (v.descuento || 0)/100);
    const total = precioConDescuento * v.cantidad;
    
    const precioDisplay = formatMoney(precioUnitario);
    const facturaDisplay = v.factura || '-';
    const facturaColor = v.factura === 'A' ? '#3498db' : v.factura === 'B' ? '#e67e22' : '#999';

    
    return `
        <tr>
            <td>${v.fecha}</td>
            <td>${v.codigoArticulo}</td>
            <td>${v.categoria || ''}</td>
            <td class="num">${v.cantidad}</td>
            <td class="num">${precioDisplay}</td>
            <td class="num">${v.descuento ? v.descuento + '%' : '-'}</td>
            <td class="num">${formatMoney(total)}</td>
            <td>${v.tipoPago || '-'}</td>
            <td style="color: ${facturaColor}; font-weight: bold;">${facturaDisplay}</td>
        </tr>
    `;
}).join('');

}

// ==================== FILTROS DE TABLA ====================
function toggleFiltrosTabla() {
    const panel = document.getElementById('filtrosTablaPanel');
    const btn = document.getElementById('btnFiltrosTabla');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.innerHTML = '<span class="icono">üîç</span> Ocultar filtros';
        cargarOpcionesFiltros();
    } else {
        panel.style.display = 'none';
        btn.innerHTML = '<span class="icono">üîç</span> Filtros';
    }
}

function cargarOpcionesFiltros() {
    const categorias = [...new Set(historicoVentas.map(v => v.categoria).filter(c => c))];
    const selectCat = document.getElementById('filtroCategoria');
    selectCat.innerHTML = '<option value="">Todas</option>' + 
        categorias.map(cat => `<option value="${cat}">${cat}</option>`).join('');

    const tiposPago = [...new Set(historicoVentas.map(v => v.tipoPago).filter(t => t))];
    const selectPago = document.getElementById('filtroTipoPago');
    selectPago.innerHTML = '<option value="">Todos</option>' + 
        tiposPago.map(tipo => `<option value="${tipo}">${tipo}</option>`).join('');
}

function aplicarFiltrosTabla() {
    const articulo = document.getElementById('filtroArticulo').value.toLowerCase();
    const categoria = document.getElementById('filtroCategoria').value;
    const tipoPago = document.getElementById('filtroTipoPago').value;
    const montoMin = parseFloat(document.getElementById('filtroMontoMin').value) || 0;
    const montoMax = parseFloat(document.getElementById('filtroMontoMax').value) || Infinity;
    const cantidadMin = parseInt(document.getElementById('filtroCantidadMin').value) || 0;

    ventasFiltradas = historicoVentas.filter(v => {
        const precioFinal = v.precio * (1 - (v.descuento || 0)/100);
        const total = precioFinal * v.cantidad;
        
        const matchArticulo = !articulo || 
            (v.codigoArticulo && v.codigoArticulo.toLowerCase().includes(articulo));
        const matchCategoria = !categoria || v.categoria === categoria;
        const matchTipoPago = !tipoPago || v.tipoPago === tipoPago;
        const matchMonto = total >= montoMin && total <= montoMax;
        const matchCantidad = v.cantidad >= cantidadMin;

        return matchArticulo && matchCategoria && matchTipoPago && matchMonto && matchCantidad;
    });

    renderTablaFiltrada();
    document.getElementById('filtrosResultado').textContent = 
        `${ventasFiltradas.length} de ${historicoVentas.length} ventas`;
}

function renderTablaFiltrada() {
    const tbody = document.getElementById('histVentasBody');
    
    if (!ventasFiltradas.length) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:#9ca3af; padding:20px;">
            No hay ventas que coincidan con los filtros
        </td></tr>`;
        return;
    }

    tbody.innerHTML = ventasFiltradas.map(v => {
        const precioUnitario = v.precio; // Precio base SIN descuento
        const precioConDescuento = v.precio * (1 - (v.descuento || 0)/100);
        const total = precioConDescuento * v.cantidad;
        
        const precioDisplay = formatMoney(precioUnitario);
        const facturaDisplay = v.factura || '-';
        const facturaColor = v.factura === 'A' ? '#3498db' : v.factura === 'B' ? '#e67e22' : '#999';

        
        return `
            <tr>
                <td>${v.fecha}</td>
                <td>${v.codigoArticulo}</td>
                <td>${v.categoria || ''}</td>
                <td class="num">${v.cantidad}</td>
                <td class="num">${precioDisplay}</td>
                <td class="num">${v.descuento ? v.descuento + '%' : '-'}</td>
                <td class="num">${formatMoney(total)}</td>
                <td>${v.tipoPago || '-'}</td>
                <td style="color: ${facturaColor}; font-weight: bold;">${facturaDisplay}</td>
            </tr>
        `;
    }).join('');
}


function limpiarFiltrosTabla() {
    document.getElementById('filtroArticulo').value = '';
    document.getElementById('filtroCategoria').value = '';
    document.getElementById('filtroTipoPago').value = '';
    document.getElementById('filtroMontoMin').value = '';
    document.getElementById('filtroMontoMax').value = '';
    document.getElementById('filtroCantidadMin').value = '';
    
    ventasFiltradas = [];
    renderHistorico(document.getElementById('historicoAnio').value, getMesesSeleccionados());
    document.getElementById('filtrosResultado').textContent = '';
}

// ==================== GR√ÅFICOS INTERACTIVOS ====================
let graficoActual = 'categorias';

function toggleSeccionGraficos() {
    const seccion = document.getElementById('seccionGraficos');
    const btn = document.querySelector('.btn-toggle-graficos');
    
    if (seccion.style.display === 'none') {
        seccion.style.display = 'block';
        btn.innerHTML = '<span id="iconoGraficos">‚ñ≤</span> Ocultar gr√°ficos';
        generarGraficos();
    } else {
        seccion.style.display = 'none';
        btn.innerHTML = '<span id="iconoGraficos">‚ñº</span> Mostrar gr√°ficos';
    }
}

function cambiarGrafico(tipo) {
    graficoActual = tipo;
    
    document.querySelectorAll('.grafico-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-chart="${tipo}"]`).classList.add('active');
    
    document.querySelectorAll('.chart-canvas').forEach(canvas => {
        canvas.classList.remove('active');
    });
    
    const chartIds = {
        'categorias': 'chartCategorias',
        'tiempo': 'chartTiempo',
        'pagos': 'chartPagos',
        'productos': 'chartProductos'
    };
    
    document.getElementById(chartIds[tipo]).classList.add('active');
}

function generarGraficos() {
    generarGraficoCategorias();
    generarGraficoTiempo();
    generarGraficoPagos();
    generarGraficoProductos();
}

function generarGraficoCategorias() {
    const datos = historicoVentas; // Sin filtros
    const categorias = {};
    
    datos.forEach(v => {
        const cat = v.categoria || 'Sin categor√≠a';
        const precioFinal = v.precio * (1 - (v.descuento || 0)/100);
        const total = precioFinal * v.cantidad;
        
        if (!categorias[cat]) {
            categorias[cat] = { total: 0, cantidad: 0 };
        }
        categorias[cat].total += total;
        categorias[cat].cantidad += v.cantidad;
    });
    
    // Ordenar seg√∫n criterio
    const criterioOrden = window.categoriasOrden || 'total';
    const entries = Object.entries(categorias).map(([cat, data]) => ({ cat, ...data }));
    
    if (criterioOrden === 'cantidad') {
        entries.sort((a, b) => b.cantidad - a.cantidad);
    } else {
        entries.sort((a, b) => b.total - a.total);
    }
    
    const totalGeneral = entries.reduce((sum, item) => sum + (criterioOrden === 'cantidad' ? item.cantidad : item.total), 0);
    
    const html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="margin: 0; color: #111827;">Ventas por categor√≠a</h4>
            <div style="display: flex; gap: 8px; background: #f3f4f6; padding: 4px; border-radius: 8px;">
                <button 
                    onclick="cambiarOrdenCategorias('cantidad')" 
                    style="padding: 6px 14px; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; ${criterioOrden === 'cantidad' ? 'background: #3b82f6; color: white;' : 'background: transparent; color: #6b7280;'}"
                >
                    üì¶ Por unidades
                </button>
                <button 
                    onclick="cambiarOrdenCategorias('total')" 
                    style="padding: 6px 14px; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; ${criterioOrden === 'total' ? 'background: #3b82f6; color: white;' : 'background: transparent; color: #6b7280;'}"
                >
                    üí∞ Por monto
                </button>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px;">
            ${entries.map((item, i) => {
                const valor = criterioOrden === 'cantidad' ? item.cantidad : item.total;
                const porcentaje = (valor / totalGeneral * 100).toFixed(1);
                const colores = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#30cfd0', '#a8edea', '#ff9a9e', '#fbc2eb'];
                const color = colores[i % colores.length];
                return `
                    <div style="padding: 16px 18px; background: linear-gradient(135deg, ${color}15, ${color}25); border-left: 4px solid ${color}; border-radius: 12px; transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="font-size: 0.8em; color: #6b7280; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">${item.cat}</div>
                        <div style="font-size: 1.5em; font-weight: 700; color: #111827; margin-bottom: 4px;">
                            ${criterioOrden === 'cantidad' ? item.cantidad + ' unidades' : formatMoney(item.total)}
                        </div>
                        <div style="font-size: 0.8em; color: #6b7280;">${porcentaje}% del total</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    document.getElementById('chartCategorias').innerHTML = html;
}

function cambiarOrdenCategorias(criterio) {
    window.categoriasOrden = criterio;
    generarGraficoCategorias();
}


function generarGraficoTiempo() {
    const datos = ventasFiltradas.length ? ventasFiltradas : historicoVentas;
    
    const ventasPorDia = {};
    datos.forEach(v => {
        const fecha = v.fecha;
        const precioFinal = v.precio * (1 - (v.descuento || 0)/100);
        const total = precioFinal * v.cantidad;
        
        if (!ventasPorDia[fecha]) {
            ventasPorDia[fecha] = { total: 0, cantidad: 0, tickets: 0 };
        }
        ventasPorDia[fecha].total += total;
        ventasPorDia[fecha].cantidad += v.cantidad;
        ventasPorDia[fecha].tickets += 1;
    });
    
    const entries = Object.entries(ventasPorDia).sort((a, b) => {
        const [diaA, mesA, anioA] = a[0].split('-');
        const [diaB, mesB, anioB] = b[0].split('-');
        return new Date(anioA, mesA - 1, diaA) - new Date(anioB, mesB - 1, diaB);
    });
    
    const maxTotal = Math.max(...entries.map(([, data]) => data.total));
    
    const html = `
        <h4 style="margin: 0 0 20px; color: #111827;">Evoluci√≥n de ventas d√≠a a d√≠a</h4>
        <div style="display: grid; gap: 8px;">
            ${entries.map(([fecha, data]) => {
                const porcentaje = (data.total / maxTotal * 100);
                return `
                    <div style="display: grid; grid-template-columns: 100px 1fr 150px; gap: 12px; align-items: center; padding: 10px; background: #f9fafb; border-radius: 8px; transition: all 0.2s ease;" onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='#f9fafb'">
                        <div style="font-size: 0.85em; font-weight: 600; color: #6b7280;">${fecha}</div>
                        <div style="background: #e5e7eb; height: 24px; border-radius: 12px; overflow: hidden; position: relative;">
                            <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${porcentaje}%; transition: width 0.3s ease; display: flex; align-items: center; padding-left: 10px;">
                                <span style="font-size: 0.75em; color: white; font-weight: 600;">${data.tickets} tickets</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: #111827; font-size: 1em;">${formatMoney(data.total)}</div>
                            <div style="font-size: 0.75em; color: #6b7280;">${data.cantidad} prendas</div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 8px;">
            <div style="font-size: 0.85em; color: #1e40af; font-weight: 600;">üìä Estad√≠sticas del per√≠odo</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">
                <div>
                    <div style="font-size: 0.75em; color: #6b7280;">D√≠a promedio</div>
                    <div style="font-size: 1.1em; font-weight: 700; color: #111827;">${formatMoney(entries.reduce((sum, [, data]) => sum + data.total, 0) / entries.length)}</div>
                </div>
                <div>
                    <div style="font-size: 0.75em; color: #6b7280;">Mejor d√≠a</div>
                    <div style="font-size: 1.1em; font-weight: 700; color: #111827;">${formatMoney(maxTotal)}</div>
                </div>
                <div>
                    <div style="font-size: 0.75em; color: #6b7280;">Total d√≠as</div>
                    <div style="font-size: 1.1em; font-weight: 700; color: #111827;">${entries.length}</div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('chartTiempo').innerHTML = html;
}

function generarGraficoPagos() {
    const datos = ventasFiltradas.length ? ventasFiltradas : historicoVentas;
    const pagos = {};
    
    datos.forEach(v => {
        const tipo = v.tipoPago || 'No especificado';
        const precioFinal = v.precio * (1 - (v.descuento || 0)/100);
        const total = precioFinal * v.cantidad;
        pagos[tipo] = (pagos[tipo] || 0) + total;
    });
    
    const entries = Object.entries(pagos).sort((a,b) => b[1] - a[1]);
    const totalGeneral = entries.reduce((sum, [,t]) => sum + t, 0);
    
    const html = `
        <h4 style="margin: 0 0 20px; color: #111827;">Distribuci√≥n de m√©todos de pago</h4>
        <div style="max-width: 600px;">
            ${entries.map(([tipo, total]) => {
                const porcentaje = (total / totalGeneral * 100).toFixed(1);
                return `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="font-weight: 600; color: #374151;">${tipo}</span>
                            <span style="font-weight: 700; color: #111827;">${formatMoney(total)}</span>
                        </div>
                        <div style="background: #e5e7eb; height: 12px; border-radius: 6px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${porcentaje}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="font-size: 0.75em; color: #6b7280; margin-top: 4px;">${porcentaje}%</div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    document.getElementById('chartPagos').innerHTML = html;
}

async function generarGraficoProductos() {
    // SIEMPRE usar historicoVentas (sin filtros)
    const datos = historicoVentas;
    const productos = {};
    
    datos.forEach(v => {
        const prod = v.codigoArticulo || 'Sin c√≥digo';
        const precioFinal = v.precio * (1 - (v.descuento || 0)/100);
        const total = precioFinal * v.cantidad;
        
        if (!productos[prod]) {
            productos[prod] = { total: 0, cantidad: 0 };
        }
        productos[prod].total += total;
        productos[prod].cantidad += v.cantidad;
    });
    
    const productosArray = [];
    for (const codigo in productos) {
        productosArray.push({
            codigo: codigo,
            total: productos[codigo].total,
            cantidad: productos[codigo].cantidad
        });
    }
    
    // Ordenar seg√∫n criterio
    const criterioOrden = window.topProductosOrden || 'cantidad';
    if (criterioOrden === 'cantidad') {
        productosArray.sort((a, b) => b.cantidad - a.cantidad);
    } else {
        productosArray.sort((a, b) => b.total - a.total);
    }
    
    const top10 = productosArray.slice(0, 10);
    
    const codigos = top10.map(item => item.codigo);
    let descripciones = {};
    
    try {
        const response = await fetch(`/api/productos/descripciones?codigos=${codigos.join(',')}`);
        if (response.ok) {
            descripciones = await response.json();
        }
    } catch (err) {
        console.error('Error obteniendo descripciones:', err);
    }
    
    const html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="margin: 0; color: #111827;">Top 10 productos m√°s vendidos</h4>
            <div style="display: flex; gap: 8px; background: #f3f4f6; padding: 4px; border-radius: 8px;">
                <button 
                    onclick="cambiarOrdenProductos('cantidad')" 
                    style="padding: 6px 14px; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; ${criterioOrden === 'cantidad' ? 'background: #3b82f6; color: white;' : 'background: transparent; color: #6b7280;'}"
                >
                    üì¶ Por unidades
                </button>
                <button 
                    onclick="cambiarOrdenProductos('total')" 
                    style="padding: 6px 14px; border: none; border-radius: 6px; font-size: 0.85em; font-weight: 600; cursor: pointer; transition: all 0.2s ease; ${criterioOrden === 'total' ? 'background: #3b82f6; color: white;' : 'background: transparent; color: #6b7280;'}"
                >
                    üí∞ Por monto
                </button>
            </div>
        </div>
        <div style="display: grid; gap: 10px;">
            ${top10.map((item, i) => `
                <div style="display: flex; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; gap: 15px; transition: all 0.2s ease;" onmouseover="this.style.background='#eff6ff'; this.style.transform='translateX(5px)'" onmouseout="this.style.background='#f9fafb'; this.style.transform='translateX(0)'">
                    <div style="flex-shrink: 0; width: 35px; height: 35px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9em;">
                        ${i + 1}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #111827; margin-bottom: 2px;">${item.codigo}</div>
                        <div style="font-size: 0.85em; color: #6b7280;">${descripciones[item.codigo] || 'Sin descripci√≥n'}</div>
                        <div style="font-size: 0.75em; color: #9ca3af; margin-top: 2px;">${item.cantidad} unidades vendidas</div>
                    </div>
                    <div style="font-weight: 700; color: #111827; font-size: 1.1em;">
                        ${formatMoney(item.total)}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('chartProductos').innerHTML = html;
}

function cambiarOrdenProductos(criterio) {
    window.topProductosOrden = criterio;
    generarGraficoProductos();
}



// ==================== IMPORTAR VENTAS DESDE CSV ====================
async function uploadVentasCSV() {
    const file = document.getElementById('csvVentas').files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/ventas/import-csv', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (!response.ok) {
            showAlert('alertaVentasCSV', result.error || 'Error al importar', 'danger');
            return;
        }

        let mensaje = `‚úÖ ${result.importadas} ventas importadas correctamente`;
        if (result.omitidas > 0) {
            mensaje += ` (${result.omitidas} filas omitidas)`;
        }

        showAlert('alertaVentasCSV', mensaje, 'success');
        
        document.getElementById('csvVentas').value = '';

        setTimeout(() => {
            cargarHistorico();
        }, 1500);
    } catch (error) {
        showAlert('alertaVentasCSV', 'Error: ' + error.message, 'danger');
    }
}

async function limpiarVentasDiciembre() {
  if (!confirm('¬øSeguro que quer√©s borrar TODAS las ventas de diciembre 2025?')) {
    return;
  }

  try {
    const response = await fetch('/api/ventas-limpiar-mes', {
      method: 'DELETE'
    });

    const result = await response.json();

    if (response.ok) {
      document.getElementById('resultadoLimpiar').textContent = `‚úÖ ${result.eliminadas} ventas eliminadas`;
      setTimeout(() => {
        cargarHistorico();
      }, 1000);
    } else {
      document.getElementById('resultadoLimpiar').textContent = `‚ùå Error: ${result.error}`;
    }
  } catch (error) {
    document.getElementById('resultadoLimpiar').textContent = `‚ùå Error: ${error.message}`;
  }
}

// ==================== GESTI√ìN DE DATOS ====================

async function cargarEstadisticasDatos() {
    try {
        const [ventasResp, productosResp, cuentasResp, cambiosResp] = await Promise.all([
            fetch('/api/ventas'),
            fetch('/api/productos'),
            fetch('/api/cuentas'),
            fetch('/api/cambios')
        ]);
        
        const ventas = await ventasResp.json();
        const productos = await productosResp.json();
        const cuentas = await cuentasResp.json();
        const cambios = await cambiosResp.json();
        
        document.getElementById('datosStats').innerHTML = `
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #1976d2;">${productos.length || 0}</div>
                <div style="color: #666; font-size: 0.9em;">Productos</div>
            </div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #388e3c;">${ventas.length || 0}</div>
                <div style="color: #666; font-size: 0.9em;">Ventas</div>
            </div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #f57c00;">${cuentas.length || 0}</div>
                <div style="color: #666; font-size: 0.9em;">Cuentas Corrientes</div>
            </div>
            <div style="background: #fce4ec; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 2em; font-weight: bold; color: #c2185b;">${cambios.length || 0}</div>
                <div style="color: #666; font-size: 0.9em;">Cambios</div>
            </div>
        `;
    } catch (e) {
        console.error('Error cargando estad√≠sticas:', e);
    }
}

async function limpiarVentasMes() {
    const mes = document.getElementById('limpiarMes').value;
    const anio = document.getElementById('limpiarAnio').value;
    const nombreMes = document.getElementById('limpiarMes').options[document.getElementById('limpiarMes').selectedIndex].text;
    
    if (!confirm(`¬øSeguro que quer√©s borrar TODAS las ventas de ${nombreMes} ${anio}?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/ventas/limpiar-mes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mes: parseInt(mes), anio: parseInt(anio) })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            document.getElementById('resultadoLimpiarMes').innerHTML = `<span style="color: green;">‚úÖ ${result.eliminadas} ventas de ${nombreMes} ${anio} eliminadas</span>`;
            cargarEstadisticasDatos();
        } else {
            document.getElementById('resultadoLimpiarMes').innerHTML = `<span style="color: red;">‚ùå ${result.error}</span>`;
        }
    } catch (error) {
        document.getElementById('resultadoLimpiarMes').innerHTML = `<span style="color: red;">‚ùå ${error.message}</span>`;
    }
}

async function limpiarTabla(tabla) {
    const nombres = {
        ventas: 'TODAS las ventas',
        cambios: 'TODOS los cambios', 
        cuentas: 'TODAS las cuentas corrientes y sus movimientos'
    };
    
    if (!confirm(`‚ö†Ô∏è ¬øEst√°s SEGURO de que quer√©s borrar ${nombres[tabla]}?\n\nEsta acci√≥n no se puede deshacer (aunque pod√©s restaurar desde un backup).`)) {
        return;
    }
    
    // Segunda confirmaci√≥n para tablas cr√≠ticas
    if (!confirm(`Esta es tu √∫ltima oportunidad de cancelar.\n\n¬øBorrar ${nombres[tabla]}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/limpiar/${tabla}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(`‚úÖ ${result.mensaje}`, 'success');
            cargarEstadisticasDatos();
        } else {
            showToast(`‚ùå ${result.error}`, 'error');
        }
    } catch (error) {
        showToast(`‚ùå ${error.message}`, 'error');
    }
}

// Cargar estad√≠sticas cuando se abre el tab de datos
const originalSwitchAdminTab = window.switchAdminTab;
window.switchAdminTab = function(tab, event) {
    document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    
    document.getElementById('admin' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
    if (event && event.target) event.target.classList.add('active');
    
    if (tab === 'datos') {
        cargarEstadisticasDatos();
    }
    if (tab === 'backups') {
        cargarBackups();
    }
};

// ==================== EXPORTAR HIST√ìRICO ====================
function exportarHistorico(formato) {
    // Usar ventas filtradas si hay, sino todas las del hist√≥rico
    const ventas = (ventasFiltradas && ventasFiltradas.length > 0) ? ventasFiltradas : historicoVentas;
    
    if (!ventas || ventas.length === 0) {
        showToast('No hay ventas para exportar. Seleccion√° un per√≠odo primero.', 'error');
        return;
    }

    const periodo = document.getElementById('histPeriodoLabel')?.textContent || 'ventas';
    const fechaExport = new Date().toISOString().split('T')[0];
    
    if (formato === 'csv') {
        exportarCSV(ventas, `ventas_${fechaExport}.csv`);
    } else {
        exportarExcel(ventas, `ventas_${fechaExport}.xlsx`);
    }
}

function exportarCSV(ventas, nombreArchivo) {
    // Headers
    const headers = ['Fecha', 'C√≥digo', 'Descripci√≥n', 'Cantidad', 'Precio Unit.', 'Descuento %', 'Total', 'Categor√≠a', 'Tipo Pago', 'Factura'];
    
    // Filas
    const filas = ventas.map(v => {
        const precioUnit = Number(v.precio) || 0;
        const cant = Number(v.cantidad) || 1;
        const desc = Number(v.descuento) || 0;
        const total = precioUnit * cant * (1 - desc/100);
        
        return [
            v.fecha,
            v.codigoArticulo,
            `"${(v.descripcion || '').replace(/"/g, '""')}"`,
            cant,
            precioUnit.toFixed(2),
            desc,
            total.toFixed(2),
            `"${(v.categoria || '').replace(/"/g, '""')}"`,
            v.tipoPago || '',
            v.factura || ''
        ].join(',');
    });
    
    const contenido = [headers.join(','), ...filas].join('\n');
    
    // BOM para Excel reconozca UTF-8
    const bom = '\uFEFF';
    const blob = new Blob([bom + contenido], { type: 'text/csv;charset=utf-8;' });
    
    descargarArchivo(blob, nombreArchivo);
    showToast(`‚úÖ ${ventas.length} ventas exportadas a CSV`, 'success');
}

function exportarExcel(ventas, nombreArchivo) {
    // Crear HTML table que Excel puede abrir
    let html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
        <head><meta charset="UTF-8">
        <style>
            td, th { border: 1px solid #ddd; padding: 8px; }
            th { background: #208090; color: white; }
            .numero { mso-number-format:"\\#\\,\\#\\#0\\.00"; }
        </style>
        </head>
        <body>
        <table>
            <tr>
                <th>Fecha</th>
                <th>C√≥digo</th>
                <th>Descripci√≥n</th>
                <th>Cantidad</th>
                <th>Precio Unit.</th>
                <th>Descuento %</th>
                <th>Total</th>
                <th>Categor√≠a</th>
                <th>Tipo Pago</th>
                <th>Factura</th>
            </tr>
    `;
    
    let totalGeneral = 0;
    let totalPrendas = 0;
    
    ventas.forEach(v => {
        const precioUnit = Number(v.precio) || 0;
        const cant = Number(v.cantidad) || 1;
        const desc = Number(v.descuento) || 0;
        const total = precioUnit * cant * (1 - desc/100);
        totalGeneral += total;
        totalPrendas += cant;
        
        html += `
            <tr>
                <td>${v.fecha}</td>
                <td>${v.codigoArticulo}</td>
                <td>${v.descripcion || ''}</td>
                <td class="numero">${cant}</td>
                <td class="numero">${precioUnit.toFixed(2)}</td>
                <td class="numero">${desc}</td>
                <td class="numero">${total.toFixed(2)}</td>
                <td>${v.categoria || ''}</td>
                <td>${v.tipoPago || ''}</td>
                <td>${v.factura || ''}</td>
            </tr>
        `;
    });
    
    // Fila de totales
    html += `
            <tr style="font-weight: bold; background: #f0f0f0;">
                <td colspan="3">TOTALES</td>
                <td class="numero">${totalPrendas}</td>
                <td></td>
                <td></td>
                <td class="numero">${totalGeneral.toFixed(2)}</td>
                <td colspan="3"></td>
            </tr>
        </table>
        </body></html>
    `;
    
    const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
    descargarArchivo(blob, nombreArchivo);
    showToast(`‚úÖ ${ventas.length} ventas exportadas a Excel`, 'success');
}

function descargarArchivo(blob, nombreArchivo) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


</script>

<div id="toast" class="toast"></div>

</body>
</html>